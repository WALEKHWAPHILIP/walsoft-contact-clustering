<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Walsoft Decision-driven contact segmentation – Walsoft Contact-Level Clustering</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-30ae6b2e5328ac7375bd033934d6d19c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./walsoft_contact_segmentation.html">Walsoft Contact Segmentation</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./walsoft_contact_segmentation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Walsoft Contact Segmentation</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#business-objective" id="toc-business-objective" class="nav-link active" data-scroll-target="#business-objective"><span class="header-section-number">1</span> Business objective</a></li>
  <li><a href="#phase-1-audit-call-level" id="toc-phase-1-audit-call-level" class="nav-link" data-scroll-target="#phase-1-audit-call-level"><span class="header-section-number">2</span> Phase 1 — Audit (call-level)</a>
  <ul class="collapse">
  <li><a href="#setup-imports-toggles" id="toc-setup-imports-toggles" class="nav-link" data-scroll-target="#setup-imports-toggles"><span class="header-section-number">2.1</span> Setup (imports + toggles)</a></li>
  <li><a href="#load-the-dataset" id="toc-load-the-dataset" class="nav-link" data-scroll-target="#load-the-dataset"><span class="header-section-number">2.2</span> Load the dataset</a></li>
  <li><a href="#identify-key-columns-robust-from-the-data-itself" id="toc-identify-key-columns-robust-from-the-data-itself" class="nav-link" data-scroll-target="#identify-key-columns-robust-from-the-data-itself"><span class="header-section-number">2.3</span> Identify key columns (robust, from the data itself)</a></li>
  <li><a href="#build-canonical-timestamp-and-numeric-duration-audit-quality-checks" id="toc-build-canonical-timestamp-and-numeric-duration-audit-quality-checks" class="nav-link" data-scroll-target="#build-canonical-timestamp-and-numeric-duration-audit-quality-checks"><span class="header-section-number">2.4</span> Build canonical timestamp and numeric duration (audit-quality checks)</a></li>
  <li><a href="#hash-a-stable-contact_id-do-not-export-raw-identifiers" id="toc-hash-a-stable-contact_id-do-not-export-raw-identifiers" class="nav-link" data-scroll-target="#hash-a-stable-contact_id-do-not-export-raw-identifiers"><span class="header-section-number">2.5</span> Hash a stable <code>contact_id</code> (do not export raw identifiers)</a></li>
  <li><a href="#derive-time-band-openclosed-day-flags-hard-constraints" id="toc-derive-time-band-openclosed-day-flags-hard-constraints" class="nav-link" data-scroll-target="#derive-time-band-openclosed-day-flags-hard-constraints"><span class="header-section-number">2.6</span> Derive time-band + open/closed-day flags (hard constraints)</a></li>
  <li><a href="#executive-summary-table-stakeholder-ready" id="toc-executive-summary-table-stakeholder-ready" class="nav-link" data-scroll-target="#executive-summary-table-stakeholder-ready"><span class="header-section-number">2.7</span> Executive summary table (stakeholder-ready)</a></li>
  <li><a href="#visual-1-monthly-call-volume-coverage" id="toc-visual-1-monthly-call-volume-coverage" class="nav-link" data-scroll-target="#visual-1-monthly-call-volume-coverage"><span class="header-section-number">2.8</span> Visual 1 — Monthly call volume (coverage)</a></li>
  <li><a href="#visual-2-duration-distribution-outlier-awareness" id="toc-visual-2-duration-distribution-outlier-awareness" class="nav-link" data-scroll-target="#visual-2-duration-distribution-outlier-awareness"><span class="header-section-number">2.9</span> Visual 2 — Duration distribution (outlier awareness)</a></li>
  <li><a href="#visual-3-time-band-mix-openclosed-day-mix-hard-constraint-diagnostics" id="toc-visual-3-time-band-mix-openclosed-day-mix-hard-constraint-diagnostics" class="nav-link" data-scroll-target="#visual-3-time-band-mix-openclosed-day-mix-hard-constraint-diagnostics"><span class="header-section-number">2.10</span> Visual 3 — Time-band mix + open/closed-day mix (hard-constraint diagnostics)</a></li>
  </ul></li>
  <li><a href="#phase-2-contact-level-features" id="toc-phase-2-contact-level-features" class="nav-link" data-scroll-target="#phase-2-contact-level-features"><span class="header-section-number">3</span> Phase 2 — Contact-level features</a>
  <ul class="collapse">
  <li><a href="#guardrails-setup" id="toc-guardrails-setup" class="nav-link" data-scroll-target="#guardrails-setup"><span class="header-section-number">3.1</span> Guardrails &amp; Setup</a></li>
  <li><a href="#base-aggregations" id="toc-base-aggregations" class="nav-link" data-scroll-target="#base-aggregations"><span class="header-section-number">3.2</span> Base Aggregations</a></li>
  <li><a href="#long-call-share" id="toc-long-call-share" class="nav-link" data-scroll-target="#long-call-share"><span class="header-section-number">3.3</span> Long-call Share</a></li>
  <li><a href="#time-band-mix" id="toc-time-band-mix" class="nav-link" data-scroll-target="#time-band-mix"><span class="header-section-number">3.4</span> Time-Band Mix</a></li>
  <li><a href="#open-vs-closed-day-mix" id="toc-open-vs-closed-day-mix" class="nav-link" data-scroll-target="#open-vs-closed-day-mix"><span class="header-section-number">3.5</span> Open vs Closed Day Mix</a></li>
  <li><a href="#category-mix-optional" id="toc-category-mix-optional" class="nav-link" data-scroll-target="#category-mix-optional"><span class="header-section-number">3.6</span> Category Mix (Optional)</a></li>
  <li><a href="#merge-all-features" id="toc-merge-all-features" class="nav-link" data-scroll-target="#merge-all-features"><span class="header-section-number">3.7</span> Merge All Features</a></li>
  <li><a href="#quick-feature-audit" id="toc-quick-feature-audit" class="nav-link" data-scroll-target="#quick-feature-audit"><span class="header-section-number">3.8</span> Quick Feature Audit</a></li>
  <li><a href="#top-activity-contacts" id="toc-top-activity-contacts" class="nav-link" data-scroll-target="#top-activity-contacts"><span class="header-section-number">3.9</span> Top Activity Contacts</a></li>
  </ul></li>
  <li><a href="#phase-3-preprocess-bullet-proof-distance-based-clustering-ready" id="toc-phase-3-preprocess-bullet-proof-distance-based-clustering-ready" class="nav-link" data-scroll-target="#phase-3-preprocess-bullet-proof-distance-based-clustering-ready"><span class="header-section-number">4</span> Phase 3 — Preprocess (bullet-proof, distance-based clustering ready)</a>
  <ul class="collapse">
  <li><a href="#freeze-an-interpretation-copy-read-only-view" id="toc-freeze-an-interpretation-copy-read-only-view" class="nav-link" data-scroll-target="#freeze-an-interpretation-copy-read-only-view"><span class="header-section-number">4.1</span> Freeze an interpretation copy (read-only view)</a></li>
  <li><a href="#define-feature-blocks-for-interpretation-and-sensitivity-analysis" id="toc-define-feature-blocks-for-interpretation-and-sensitivity-analysis" class="nav-link" data-scroll-target="#define-feature-blocks-for-interpretation-and-sensitivity-analysis"><span class="header-section-number">4.2</span> Define feature blocks (for interpretation and sensitivity analysis)</a></li>
  <li><a href="#select-default-model-features-no-timestamps-no-category-mix-by-default" id="toc-select-default-model-features-no-timestamps-no-category-mix-by-default" class="nav-link" data-scroll-target="#select-default-model-features-no-timestamps-no-category-mix-by-default"><span class="header-section-number">4.3</span> Select default model features (no timestamps, no category mix by default)</a></li>
  <li><a href="#diagnostics-before-preprocessing-missingness-inf-safety" id="toc-diagnostics-before-preprocessing-missingness-inf-safety" class="nav-link" data-scroll-target="#diagnostics-before-preprocessing-missingness-inf-safety"><span class="header-section-number">4.4</span> Diagnostics before preprocessing (missingness + inf safety)</a></li>
  <li><a href="#stability-strategy-recommended-drop-only-truly-constant-columns-clip-extremes" id="toc-stability-strategy-recommended-drop-only-truly-constant-columns-clip-extremes" class="nav-link" data-scroll-target="#stability-strategy-recommended-drop-only-truly-constant-columns-clip-extremes"><span class="header-section-number">4.5</span> Stability strategy (recommended): drop only truly constant columns + clip extremes</a></li>
  <li><a href="#median-imputation-robustscaler" id="toc-median-imputation-robustscaler" class="nav-link" data-scroll-target="#median-imputation-robustscaler"><span class="header-section-number">4.6</span> Median imputation + RobustScaler</a></li>
  <li><a href="#diagnostics-identify-any-dominating-feature-in-scaled-space" id="toc-diagnostics-identify-any-dominating-feature-in-scaled-space" class="nav-link" data-scroll-target="#diagnostics-identify-any-dominating-feature-in-scaled-space"><span class="header-section-number">4.7</span> Diagnostics: identify any dominating feature in scaled space</a></li>
  <li><a href="#preprocess-audit-compact-decision-useful" id="toc-preprocess-audit-compact-decision-useful" class="nav-link" data-scroll-target="#preprocess-audit-compact-decision-useful"><span class="header-section-number">4.8</span> Preprocess audit (compact, decision-useful)</a></li>
  <li><a href="#store-preprocessing-artifacts-in-memory-safe-by-default" id="toc-store-preprocessing-artifacts-in-memory-safe-by-default" class="nav-link" data-scroll-target="#store-preprocessing-artifacts-in-memory-safe-by-default"><span class="header-section-number">4.9</span> Store preprocessing artifacts (in-memory, safe by default)</a></li>
  <li><a href="#a-final-numeric-stability-guardrail" id="toc-a-final-numeric-stability-guardrail" class="nav-link" data-scroll-target="#a-final-numeric-stability-guardrail"><span class="header-section-number">4.10</span> A Final numeric stability guardrail</a></li>
  </ul></li>
  <li><a href="#phase-4-choose-k-model-selection-for-clustering" id="toc-phase-4-choose-k-model-selection-for-clustering" class="nav-link" data-scroll-target="#phase-4-choose-k-model-selection-for-clustering"><span class="header-section-number">5</span> Phase 4 — Choose <span class="math inline">\(K\)</span> (model selection for clustering)</a>
  <ul class="collapse">
  <li><a href="#compute-k-search-metrics" id="toc-compute-k-search-metrics" class="nav-link" data-scroll-target="#compute-k-search-metrics"><span class="header-section-number">5.1</span> Compute <span class="math inline">\(K\)</span>-search metrics</a></li>
  <li><a href="#visualize-metrics-elbow-quality-trade-offs" id="toc-visualize-metrics-elbow-quality-trade-offs" class="nav-link" data-scroll-target="#visualize-metrics-elbow-quality-trade-offs"><span class="header-section-number">5.2</span> Visualize metrics (elbow + quality trade-offs)</a></li>
  <li><a href="#candidate-shortlist-data-driven" id="toc-candidate-shortlist-data-driven" class="nav-link" data-scroll-target="#candidate-shortlist-data-driven"><span class="header-section-number">5.3</span> Candidate shortlist (data-driven)</a></li>
  <li><a href="#what-the-metrics-say-from-first-principles" id="toc-what-the-metrics-say-from-first-principles" class="nav-link" data-scroll-target="#what-the-metrics-say-from-first-principles"><span class="header-section-number">5.4</span> What the metrics say (from first principles)</a></li>
  <li><a href="#decision" id="toc-decision" class="nav-link" data-scroll-target="#decision"><span class="header-section-number">5.5</span> Decision</a></li>
  <li><a href="#optional-why-we-may-explore-k5-exploratory-only" id="toc-optional-why-we-may-explore-k5-exploratory-only" class="nav-link" data-scroll-target="#optional-why-we-may-explore-k5-exploratory-only"><span class="header-section-number">5.6</span> Optional: why we may explore <span class="math inline">\(K=5\)</span> (exploratory only)</a></li>
  </ul></li>
  <li><a href="#phase-5-fit-and-interpret-clusters-k-means-k4" id="toc-phase-5-fit-and-interpret-clusters-k-means-k4" class="nav-link" data-scroll-target="#phase-5-fit-and-interpret-clusters-k-means-k4"><span class="header-section-number">6</span> Phase 5 — Fit and interpret clusters (K-means, <span class="math inline">\(K=4\)</span>)</a>
  <ul class="collapse">
  <li><a href="#fit-k-means-k4-and-store-labels" id="toc-fit-k-means-k4-and-store-labels" class="nav-link" data-scroll-target="#fit-k-means-k4-and-store-labels"><span class="header-section-number">6.1</span> Fit K-means (<span class="math inline">\(K=4\)</span>) and store labels</a></li>
  <li><a href="#join-clusters-back-to-contact-level-table-raw-units" id="toc-join-clusters-back-to-contact-level-table-raw-units" class="nav-link" data-scroll-target="#join-clusters-back-to-contact-level-table-raw-units"><span class="header-section-number">6.2</span> Join clusters back to contact-level table (raw units)</a></li>
  <li><a href="#cluster-cards-robust-medians-size" id="toc-cluster-cards-robust-medians-size" class="nav-link" data-scroll-target="#cluster-cards-robust-medians-size"><span class="header-section-number">6.3</span> Cluster “cards” (robust medians + size)</a></li>
  <li><a href="#within-cluster-spread-check-to-avoid-misleading-medians" id="toc-within-cluster-spread-check-to-avoid-misleading-medians" class="nav-link" data-scroll-target="#within-cluster-spread-check-to-avoid-misleading-medians"><span class="header-section-number">6.4</span> Within-cluster spread check (to avoid misleading medians)</a></li>
  <li><a href="#timing-patterns-mean-shares-with-any-non-business-hours-sunday-activity" id="toc-timing-patterns-mean-shares-with-any-non-business-hours-sunday-activity" class="nav-link" data-scroll-target="#timing-patterns-mean-shares-with-any-non-business-hours-sunday-activity"><span class="header-section-number">6.5</span> Timing patterns (mean shares + % with any non-business-hours / Sunday activity)</a></li>
  <li><a href="#segment-names-action-policy-stakeholder-ready-layer" id="toc-segment-names-action-policy-stakeholder-ready-layer" class="nav-link" data-scroll-target="#segment-names-action-policy-stakeholder-ready-layer"><span class="header-section-number">6.6</span> Segment names + action policy (stakeholder-ready layer)</a></li>
  <li><a href="#cluster-narrative-auto-generated-from-the-cards" id="toc-cluster-narrative-auto-generated-from-the-cards" class="nav-link" data-scroll-target="#cluster-narrative-auto-generated-from-the-cards"><span class="header-section-number">6.7</span> Cluster narrative (auto-generated from the cards)</a></li>
  <li><a href="#what-decisions-can-the-business-make-with-these-segments" id="toc-what-decisions-can-the-business-make-with-these-segments" class="nav-link" data-scroll-target="#what-decisions-can-the-business-make-with-these-segments"><span class="header-section-number">6.8</span> “What decisions can the business make with these segments?”</a></li>
  <li><a href="#store-artifacts-for-later-phases-robustness-sensitivity-pca" id="toc-store-artifacts-for-later-phases-robustness-sensitivity-pca" class="nav-link" data-scroll-target="#store-artifacts-for-later-phases-robustness-sensitivity-pca"><span class="header-section-number">6.9</span> Store artifacts for later phases (robustness, sensitivity, PCA)</a></li>
  </ul></li>
  <li><a href="#phase-6-robustness-and-sensitivity-do-the-clusters-hold-up" id="toc-phase-6-robustness-and-sensitivity-do-the-clusters-hold-up" class="nav-link" data-scroll-target="#phase-6-robustness-and-sensitivity-do-the-clusters-hold-up"><span class="header-section-number">7</span> Phase 6 — Robustness and sensitivity (do the clusters “hold up”?)</a>
  <ul class="collapse">
  <li><a href="#seed-stability-test-ari-across-many-random-seeds" id="toc-seed-stability-test-ari-across-many-random-seeds" class="nav-link" data-scroll-target="#seed-stability-test-ari-across-many-random-seeds"><span class="header-section-number">7.2</span> Seed stability test (ARI across many random seeds)</a></li>
  <li><a href="#worst-case-rerun-inspection-label-aligned" id="toc-worst-case-rerun-inspection-label-aligned" class="nav-link" data-scroll-target="#worst-case-rerun-inspection-label-aligned"><span class="header-section-number">7.3</span> “Worst-case” rerun inspection (label-aligned)</a></li>
  <li><a href="#feature-block-sensitivity-drop-one-block-tests" id="toc-feature-block-sensitivity-drop-one-block-tests" class="nav-link" data-scroll-target="#feature-block-sensitivity-drop-one-block-tests"><span class="header-section-number">7.4</span> Feature-block sensitivity (drop-one-block tests)</a></li>
  <li><a href="#sensitivity-summary-decision-useful" id="toc-sensitivity-summary-decision-useful" class="nav-link" data-scroll-target="#sensitivity-summary-decision-useful"><span class="header-section-number">7.5</span> Sensitivity summary (decision-useful)</a></li>
  <li><a href="#store-robustness-artifacts-for-later-reporting" id="toc-store-robustness-artifacts-for-later-reporting" class="nav-link" data-scroll-target="#store-robustness-artifacts-for-later-reporting"><span class="header-section-number">7.6</span> Store robustness artifacts (for later reporting)</a></li>
  </ul></li>
  <li><a href="#phase-7-pca-visualization-for-interpretation-only" id="toc-phase-7-pca-visualization-for-interpretation-only" class="nav-link" data-scroll-target="#phase-7-pca-visualization-for-interpretation-only"><span class="header-section-number">8</span> Phase 7 — PCA visualization (for interpretation only)</a>
  <ul class="collapse">
  <li><a href="#fit-pca-2-components-on-the-clustering-matrix" id="toc-fit-pca-2-components-on-the-clustering-matrix" class="nav-link" data-scroll-target="#fit-pca-2-components-on-the-clustering-matrix"><span class="header-section-number">8.1</span> Fit PCA (<span class="math inline">\(2\)</span> components) on the clustering matrix</a></li>
  <li><a href="#build-a-plotting-table-hashed-id-pca-coordinates-cluster" id="toc-build-a-plotting-table-hashed-id-pca-coordinates-cluster" class="nav-link" data-scroll-target="#build-a-plotting-table-hashed-id-pca-coordinates-cluster"><span class="header-section-number">8.2</span> Build a plotting table (hashed id + PCA coordinates + cluster)</a></li>
  <li><a href="#pca-scatter-plot-clusters-on-the-2d-map" id="toc-pca-scatter-plot-clusters-on-the-2d-map" class="nav-link" data-scroll-target="#pca-scatter-plot-clusters-on-the-2d-map"><span class="header-section-number">8.3</span> PCA scatter plot (clusters on the 2D map)</a></li>
  <li><a href="#optional-cluster-centroids-projected-into-pca-space" id="toc-optional-cluster-centroids-projected-into-pca-space" class="nav-link" data-scroll-target="#optional-cluster-centroids-projected-into-pca-space"><span class="header-section-number">8.4</span> Optional: cluster centroids projected into PCA space</a></li>
  <li><a href="#interpretation-guidance-what-we-conclude-from-pca" id="toc-interpretation-guidance-what-we-conclude-from-pca" class="nav-link" data-scroll-target="#interpretation-guidance-what-we-conclude-from-pca"><span class="header-section-number">8.5</span> Interpretation guidance (what we conclude from PCA)</a></li>
  <li><a href="#store-pca-artifacts-for-the-final-report" id="toc-store-pca-artifacts-for-the-final-report" class="nav-link" data-scroll-target="#store-pca-artifacts-for-the-final-report"><span class="header-section-number">8.6</span> Store PCA artifacts (for the final report)</a></li>
  </ul></li>
  <li><a href="#what-pca-tells-us-interpretation-only" id="toc-what-pca-tells-us-interpretation-only" class="nav-link" data-scroll-target="#what-pca-tells-us-interpretation-only"><span class="header-section-number">9</span> What PCA tells us (interpretation only)</a>
  <ul class="collapse">
  <li><a href="#variance-captured" id="toc-variance-captured" class="nav-link" data-scroll-target="#variance-captured"><span class="header-section-number">9.1</span> Variance captured</a></li>
  <li><a href="#visual-separation-sanity-check" id="toc-visual-separation-sanity-check" class="nav-link" data-scroll-target="#visual-separation-sanity-check"><span class="header-section-number">9.2</span> Visual separation (sanity-check)</a></li>
  <li><a href="#centroids-on-the-pca-map" id="toc-centroids-on-the-pca-map" class="nav-link" data-scroll-target="#centroids-on-the-pca-map"><span class="header-section-number">9.3</span> Centroids on the PCA map</a></li>
  </ul></li>
  <li><a href="#phase-8-final-deliverables-stakeholder-ready-outputs" id="toc-phase-8-final-deliverables-stakeholder-ready-outputs" class="nav-link" data-scroll-target="#phase-8-final-deliverables-stakeholder-ready-outputs"><span class="header-section-number">10</span> Phase 8 — Final deliverables (stakeholder-ready outputs)</a>
  <ul class="collapse">
  <li><a href="#assemble-the-final-segment-table-labels-key-medians" id="toc-assemble-the-final-segment-table-labels-key-medians" class="nav-link" data-scroll-target="#assemble-the-final-segment-table-labels-key-medians"><span class="header-section-number">10.1</span> Assemble the “final segment table” (labels + key medians)</a></li>
  <li><a href="#decision-rules-crm-outreach-policy" id="toc-decision-rules-crm-outreach-policy" class="nav-link" data-scroll-target="#decision-rules-crm-outreach-policy"><span class="header-section-number">10.2</span> Decision rules (CRM / outreach policy)</a></li>
  <li><a href="#executive-summary-one-screen" id="toc-executive-summary-one-screen" class="nav-link" data-scroll-target="#executive-summary-one-screen"><span class="header-section-number">10.3</span> “Executive summary” (one screen)</a></li>
  <li><a href="#findings-plain-english-decision-first" id="toc-findings-plain-english-decision-first" class="nav-link" data-scroll-target="#findings-plain-english-decision-first"><span class="header-section-number">10.4</span> Findings (plain-English, decision-first)</a></li>
  <li><a href="#limitations-and-how-not-to-misuse-this" id="toc-limitations-and-how-not-to-misuse-this" class="nav-link" data-scroll-target="#limitations-and-how-not-to-misuse-this"><span class="header-section-number">10.5</span> Limitations and “how not to misuse this”</a></li>
  <li><a href="#optional-export-portfolio-artifacts-off-by-default" id="toc-optional-export-portfolio-artifacts-off-by-default" class="nav-link" data-scroll-target="#optional-export-portfolio-artifacts-off-by-default"><span class="header-section-number">10.6</span> Optional: export portfolio artifacts (OFF by default)</a></li>
  </ul></li>
  <li><a href="#phase-10-final-wrap-up-competition-framing-decision-narrative" id="toc-phase-10-final-wrap-up-competition-framing-decision-narrative" class="nav-link" data-scroll-target="#phase-10-final-wrap-up-competition-framing-decision-narrative"><span class="header-section-number">11</span> Phase 10 — Final wrap-up (competition framing + decision narrative)</a>
  <ul class="collapse">
  <li><a href="#competition-prompt-what-we-were-given" id="toc-competition-prompt-what-we-were-given" class="nav-link" data-scroll-target="#competition-prompt-what-we-were-given"><span class="header-section-number">11.1</span> Competition prompt (what we were given)</a></li>
  <li><a href="#what-we-had-to-produce-deliverable-definition" id="toc-what-we-had-to-produce-deliverable-definition" class="nav-link" data-scroll-target="#what-we-had-to-produce-deliverable-definition"><span class="header-section-number">11.2</span> What we had to produce (deliverable definition)</a></li>
  <li><a href="#what-we-built-end-to-end-pipeline" id="toc-what-we-built-end-to-end-pipeline" class="nav-link" data-scroll-target="#what-we-built-end-to-end-pipeline"><span class="header-section-number">11.3</span> What we built (end-to-end pipeline)</a></li>
  <li><a href="#the-segments-what-we-found-what-to-do" id="toc-the-segments-what-we-found-what-to-do" class="nav-link" data-scroll-target="#the-segments-what-we-found-what-to-do"><span class="header-section-number">11.4</span> The segments (what we found + what to do)</a></li>
  <li><a href="#proof-the-solution-holds-up-robustness" id="toc-proof-the-solution-holds-up-robustness" class="nav-link" data-scroll-target="#proof-the-solution-holds-up-robustness"><span class="header-section-number">11.5</span> Proof the solution “holds up” (robustness)</a></li>
  <li><a href="#what-pca-contributed-interpretation-only" id="toc-what-pca-contributed-interpretation-only" class="nav-link" data-scroll-target="#what-pca-contributed-interpretation-only"><span class="header-section-number">11.6</span> What PCA contributed (interpretation only)</a></li>
  <li><a href="#decision-use-what-a-business-can-do-with-these-segments" id="toc-decision-use-what-a-business-can-do-with-these-segments" class="nav-link" data-scroll-target="#decision-use-what-a-business-can-do-with-these-segments"><span class="header-section-number">11.7</span> Decision use: what a business can do with these segments</a></li>
  <li><a href="#limitations-how-not-to-misuse-this" id="toc-limitations-how-not-to-misuse-this" class="nav-link" data-scroll-target="#limitations-how-not-to-misuse-this"><span class="header-section-number">11.8</span> Limitations (how not to misuse this)</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Walsoft Decision-driven contact segmentation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="business-objective" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="business-objective"><span class="header-section-number">1</span> Business objective</h2>
<p>Segment contacts into <strong>actionable behavioral groups</strong> to support <strong>outreach planning, CRM prioritization, and relationship management</strong>.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Hard constraints enforced in this project
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Time bands (exact):</strong></p>
<ul>
<li><code>business_hours</code>: 08:00–17:59<br>
</li>
<li><code>evening</code>: 18:00–20:59<br>
</li>
<li><code>late_night</code>: 21:00–23:59<br>
</li>
<li><code>early_morning</code>: 00:00–07:59</li>
</ul>
<p><strong>Working days:</strong></p>
<ul>
<li>Open days: Monday–Saturday<br>
</li>
<li>Closed day: Sunday only</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Workflow (phases)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Phase 1 Audit → Phase 2 Contact-level features → Phase 3 Preprocess → Phase 4 Choose K → Phase 5 Fit/Interpret → then stability/ARI → sensitivity (feature blocks) → PCA viz → final recommendations.</p>
</div>
</div>
</section>
<section id="phase-1-audit-call-level" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="phase-1-audit-call-level"><span class="header-section-number">2</span> Phase 1 — Audit (call-level)</h2>
<section id="setup-imports-toggles" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="setup-imports-toggles"><span class="header-section-number">2.1</span> Setup (imports + toggles)</h3>
</section>
<section id="load-the-dataset" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="load-the-dataset"><span class="header-section-number">2.2</span> Load the dataset</h3>
<section id="load-data" class="level4" data-number="2.2.1">
<h4 data-number="2.2.1" class="anchored" data-anchor-id="load-data"><span class="header-section-number">2.2.1</span> Load data</h4>
<div id="0746bb72" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load dataset (no assumptions, no output)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(DATA_URL)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="dataset-overview" class="level4" data-number="2.2.2">
<h4 data-number="2.2.2" class="anchored" data-anchor-id="dataset-overview"><span class="header-section-number">2.2.2</span> Dataset overview</h4>
<div id="77cedc85" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset overview (executive-level structural metrics)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>dataset_overview <span class="op">=</span> pd.DataFrame({</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Metric"</span>: [</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Rows"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Columns"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Total cells"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Memory usage (MB)"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Value"</span>: [</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">int</span>(df.shape[<span class="dv">0</span>]),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">int</span>(df.shape[<span class="dv">1</span>]),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">int</span>(df.shape[<span class="dv">0</span>] <span class="op">*</span> df.shape[<span class="dv">1</span>]),</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>df<span class="sc">.</span>memory_usage(deep<span class="op">=</span><span class="va">True</span>)<span class="sc">.</span><span class="bu">sum</span>() <span class="op">/</span> <span class="fl">1e6</span><span class="sc">:.2f}</span><span class="ss">"</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>dataset_overview</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="72">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Metric</th>
<th data-quarto-table-cell-role="th">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Rows</td>
<td>24952</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Columns</td>
<td>9</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Total cells</td>
<td>224568</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Memory usage (MB)</td>
<td>9.10</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="column-inventory-schema-inspection" class="level4" data-number="2.2.3">
<h4 data-number="2.2.3" class="anchored" data-anchor-id="column-inventory-schema-inspection"><span class="header-section-number">2.2.3</span> Column inventory (schema inspection)</h4>
<div id="cce9abd0" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Column inventory (schema audit table)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>column_inventory <span class="op">=</span> (</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame({</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Column name"</span>: df.columns,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Data type"</span>: df.dtypes.astype(<span class="bu">str</span>),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Non-null count"</span>: df.notna().<span class="bu">sum</span>().values,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Non-null rate"</span>: (df.notna().mean()).<span class="bu">round</span>(<span class="dv">3</span>).values</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"Column name"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>column_inventory</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="73">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Column name</th>
<th data-quarto-table-cell-role="th">Data type</th>
<th data-quarto-table-cell-role="th">Non-null count</th>
<th data-quarto-table-cell-role="th">Non-null rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>category</td>
<td>str</td>
<td>24952</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>date_stamp</td>
<td>str</td>
<td>24952</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>day-of_week</td>
<td>str</td>
<td>24952</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>dialled_phone_number</td>
<td>int64</td>
<td>24952</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>duration_in_seconds</td>
<td>int64</td>
<td>24952</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>month</td>
<td>str</td>
<td>24952</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>name</td>
<td>str</td>
<td>24952</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>time</td>
<td>str</td>
<td>24952</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>year</td>
<td>int64</td>
<td>24952</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="sample-records-visual-sanity-check" class="level4" data-number="2.2.4">
<h4 data-number="2.2.4" class="anchored" data-anchor-id="sample-records-visual-sanity-check"><span class="header-section-number">2.2.4</span> Sample records (visual sanity check)</h4>
<div id="1771b323" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample records (human sanity check only)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="74">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date_stamp</th>
<th data-quarto-table-cell-role="th">time</th>
<th data-quarto-table-cell-role="th">day-of_week</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">dialled_phone_number</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">duration_in_seconds</th>
<th data-quarto-table-cell-role="th">category</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>1/1/2022</td>
<td>16:03:01</td>
<td>Saturday</td>
<td>January</td>
<td>2022</td>
<td>648578192</td>
<td>Abel</td>
<td>179</td>
<td>Unknown</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>1/1/2022</td>
<td>16:06:17</td>
<td>Saturday</td>
<td>January</td>
<td>2022</td>
<td>814500001</td>
<td>Husband CEL01</td>
<td>66</td>
<td>Family</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>1/1/2022</td>
<td>19:08:44</td>
<td>Saturday</td>
<td>January</td>
<td>2022</td>
<td>814500001</td>
<td>Husband CEL01</td>
<td>38</td>
<td>Family</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
</section>
<section id="identify-key-columns-robust-from-the-data-itself" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="identify-key-columns-robust-from-the-data-itself"><span class="header-section-number">2.3</span> Identify key columns (robust, from the data itself)</h3>
<div id="aed7a7f2" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify key columns (schema audit, no assumptions)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalise column names once (single source of truth)</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>col_map <span class="op">=</span> {c: c.lower().strip() <span class="cf">for</span> c <span class="kw">in</span> df.columns}</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Detection rules (explicit, auditable, extensible)</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>DETECTION_RULES <span class="op">=</span> OrderedDict({</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Date"</span>: {</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"description"</span>: <span class="st">"Calendar date component"</span>,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"match_any"</span>: [<span class="st">"date"</span>]</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Time"</span>: {</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"description"</span>: <span class="st">"Clock time component"</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"match_exact_or_contains"</span>: [<span class="st">"time"</span>]</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Duration"</span>: {</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"description"</span>: <span class="st">"Call duration (numeric, any unit)"</span>,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"match_any"</span>: [<span class="st">"duration"</span>, <span class="st">"seconds"</span>, <span class="st">"secs"</span>, <span class="st">"sec"</span>, <span class="st">"minutes"</span>, <span class="st">"mins"</span>]</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Identifier"</span>: {</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"description"</span>: <span class="st">"Contact or phone identifier"</span>,</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"match_any"</span>: [<span class="st">"dialled"</span>, <span class="st">"dialed"</span>, <span class="st">"phone"</span>, <span class="st">"number"</span>, <span class="st">"contact"</span>]</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Category"</span>: {</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"description"</span>: <span class="st">"Human or system call classification"</span>,</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"match_any"</span>: [<span class="st">"category"</span>]</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply detection rules</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>records <span class="op">=</span> []</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> field, rule <span class="kw">in</span> DETECTION_RULES.items():</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    detected <span class="op">=</span> []</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col, lc <span class="kw">in</span> col_map.items():</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"match_exact_or_contains"</span> <span class="kw">in</span> rule:</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(lc <span class="op">==</span> k <span class="kw">or</span> k <span class="kw">in</span> lc <span class="cf">for</span> k <span class="kw">in</span> rule[<span class="st">"match_exact_or_contains"</span>]):</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>                detected.append(col)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">"match_any"</span> <span class="kw">in</span> rule:</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(k <span class="kw">in</span> lc <span class="cf">for</span> k <span class="kw">in</span> rule[<span class="st">"match_any"</span>]):</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>                detected.append(col)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    records.append({</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Field type"</span>: field,</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Purpose"</span>: rule[<span class="st">"description"</span>],</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Detected columns"</span>: <span class="st">", "</span>.join(detected) <span class="cf">if</span> detected <span class="cf">else</span> <span class="st">"—"</span>,</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Count"</span>: <span class="bu">len</span>(detected),</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Status"</span>: <span class="st">"OK"</span> <span class="cf">if</span> detected <span class="cf">else</span> <span class="st">"Missing"</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Canonical schema audit table (Quarto renders automatically)</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>schema_audit <span class="op">=</span> pd.DataFrame(records)</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>schema_audit</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="75">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Field type</th>
<th data-quarto-table-cell-role="th">Purpose</th>
<th data-quarto-table-cell-role="th">Detected columns</th>
<th data-quarto-table-cell-role="th">Count</th>
<th data-quarto-table-cell-role="th">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Date</td>
<td>Calendar date component</td>
<td>date_stamp</td>
<td>1</td>
<td>OK</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Time</td>
<td>Clock time component</td>
<td>time</td>
<td>1</td>
<td>OK</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Duration</td>
<td>Call duration (numeric, any unit)</td>
<td>duration_in_seconds</td>
<td>1</td>
<td>OK</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Identifier</td>
<td>Contact or phone identifier</td>
<td>dialled_phone_number</td>
<td>1</td>
<td>OK</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Category</td>
<td>Human or system call classification</td>
<td>category</td>
<td>1</td>
<td>OK</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="build-canonical-timestamp-and-numeric-duration-audit-quality-checks" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="build-canonical-timestamp-and-numeric-duration-audit-quality-checks"><span class="header-section-number">2.4</span> Build canonical timestamp and numeric duration (audit-quality checks)</h3>
<section id="validate-required-schema" class="level4" data-number="2.4.1">
<h4 data-number="2.4.1" class="anchored" data-anchor-id="validate-required-schema"><span class="header-section-number">2.4.1</span> Validate required schema</h4>
<div id="0d47330b" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Validate required columns exist (hard audit gate)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>required_cols <span class="op">=</span> [</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"date_stamp"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"time"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"duration_in_seconds"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dialled_phone_number"</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>missing_required <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> required_cols <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> df.columns]</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>schema_validation <span class="op">=</span> pd.DataFrame({</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Required column"</span>: required_cols,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Present in dataset"</span>: [c <span class="kw">in</span> df.columns <span class="cf">for</span> c <span class="kw">in</span> required_cols]</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>schema_validation</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="76">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Required column</th>
<th data-quarto-table-cell-role="th">Present in dataset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>date_stamp</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>time</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>duration_in_seconds</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>dialled_phone_number</td>
<td>True</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="5e87f66d" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop execution if schema is invalid</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(missing_required) <span class="op">==</span> <span class="dv">0</span>, <span class="ss">f"Missing required columns: </span><span class="sc">{</span>missing_required<span class="sc">}</span><span class="ss">"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="build-canonical-fields" class="level4" data-number="2.4.2">
<h4 data-number="2.4.2" class="anchored" data-anchor-id="build-canonical-fields"><span class="header-section-number">2.4.2</span> Build canonical fields</h4>
<div id="e1bbdda4" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Canonical timestamp</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"call_ts"</span>] <span class="op">=</span> pd.to_datetime(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"date_stamp"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.strip() <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"time"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.strip(),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    errors<span class="op">=</span><span class="st">"coerce"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Canonical duration (seconds)</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"dur_sec"</span>] <span class="op">=</span> pd.to_numeric(</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"duration_in_seconds"</span>],</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    errors<span class="op">=</span><span class="st">"coerce"</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="data-integrity-audit" class="level4" data-number="2.4.3">
<h4 data-number="2.4.3" class="anchored" data-anchor-id="data-integrity-audit"><span class="header-section-number">2.4.3</span> Data integrity audit</h4>
<div id="47783ac0" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>bad_ts <span class="op">=</span> <span class="bu">int</span>(df[<span class="st">"call_ts"</span>].isna().<span class="bu">sum</span>())</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>bad_dur <span class="op">=</span> <span class="bu">int</span>(df[<span class="st">"dur_sec"</span>].isna().<span class="bu">sum</span>())</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>negative_dur <span class="op">=</span> <span class="bu">int</span>((df[<span class="st">"dur_sec"</span>] <span class="op">&lt;</span> <span class="dv">0</span>).<span class="bu">sum</span>())</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>timestamp_min <span class="op">=</span> df[<span class="st">"call_ts"</span>].<span class="bu">min</span>()</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>timestamp_max <span class="op">=</span> df[<span class="st">"call_ts"</span>].<span class="bu">max</span>()</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>integrity_audit <span class="op">=</span> pd.DataFrame({</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Check"</span>: [</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Timestamp parse failures"</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Duration numeric failures"</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Negative durations"</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Timestamp range (min)"</span>,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Timestamp range (max)"</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Timestamp success rate"</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Duration success rate"</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Value"</span>: [</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        bad_ts,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        bad_dur,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        negative_dur,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">str</span>(timestamp_min),</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">str</span>(timestamp_max),</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'call_ts'</span>]<span class="sc">.</span>notna()<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">"</span>,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'dur_sec'</span>]<span class="sc">.</span>notna()<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">"</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>integrity_audit</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="79">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Check</th>
<th data-quarto-table-cell-role="th">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Timestamp parse failures</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Duration numeric failures</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Negative durations</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Timestamp range (min)</td>
<td>2022-01-01 16:03:01</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Timestamp range (max)</td>
<td>2024-10-04 20:15:16</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Timestamp success rate</td>
<td>1.000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Duration success rate</td>
<td>1.000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="hard-integrity-gates" class="level4" data-number="2.4.4">
<h4 data-number="2.4.4" class="anchored" data-anchor-id="hard-integrity-gates"><span class="header-section-number">2.4.4</span> Hard integrity gates</h4>
<div id="b3c98911" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> bad_ts <span class="op">==</span> <span class="dv">0</span>, <span class="st">"Timestamp parsing failed for some rows."</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> bad_dur <span class="op">==</span> <span class="dv">0</span>, <span class="st">"Duration numeric conversion failed for some rows."</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> negative_dur <span class="op">==</span> <span class="dv">0</span>, <span class="st">"Negative durations detected."</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="hash-a-stable-contact_id-do-not-export-raw-identifiers" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="hash-a-stable-contact_id-do-not-export-raw-identifiers"><span class="header-section-number">2.5</span> Hash a stable <code>contact_id</code> (do not export raw identifiers)</h3>
<div id="eccccedb" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stable_contact_id(x: <span class="bu">int</span> <span class="op">|</span> <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">str</span>(x).encode(<span class="st">"utf-8"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hashlib.sha256(s).hexdigest()[:<span class="dv">12</span>]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"contact_id"</span>] <span class="op">=</span> df[<span class="st">"dialled_phone_number"</span>].<span class="bu">map</span>(stable_contact_id)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Unique contacts (hashed):"</span>, <span class="bu">int</span>(df[<span class="st">"contact_id"</span>].nunique()))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df[<span class="st">"contact_id"</span>].isna().<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Unique contacts (hashed): 2091</code></pre>
</div>
</div>
</section>
<section id="derive-time-band-openclosed-day-flags-hard-constraints" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="derive-time-band-openclosed-day-flags-hard-constraints"><span class="header-section-number">2.6</span> Derive time-band + open/closed-day flags (hard constraints)</h3>
<div id="2a62906b" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"hour"</span>] <span class="op">=</span> df[<span class="st">"call_ts"</span>].dt.hour</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"dow"</span>] <span class="op">=</span> df[<span class="st">"call_ts"</span>].dt.dayofweek  <span class="co"># Mon=0..Sun=6</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_time_band(hour: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> TIME_BANDS[<span class="st">"early_morning"</span>][<span class="dv">0</span>] <span class="op">&lt;=</span> hour <span class="op">&lt;=</span> TIME_BANDS[<span class="st">"early_morning"</span>][<span class="dv">1</span>]:</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"early_morning"</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> TIME_BANDS[<span class="st">"business_hours"</span>][<span class="dv">0</span>] <span class="op">&lt;=</span> hour <span class="op">&lt;=</span> TIME_BANDS[<span class="st">"business_hours"</span>][<span class="dv">1</span>]:</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"business_hours"</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> TIME_BANDS[<span class="st">"evening"</span>][<span class="dv">0</span>] <span class="op">&lt;=</span> hour <span class="op">&lt;=</span> TIME_BANDS[<span class="st">"evening"</span>][<span class="dv">1</span>]:</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"evening"</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> TIME_BANDS[<span class="st">"late_night"</span>][<span class="dv">0</span>] <span class="op">&lt;=</span> hour <span class="op">&lt;=</span> TIME_BANDS[<span class="st">"late_night"</span>][<span class="dv">1</span>]:</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"late_night"</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Hour out of range: </span><span class="sc">{</span>hour<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"time_band"</span>] <span class="op">=</span> df[<span class="st">"hour"</span>].<span class="bu">map</span>(assign_time_band)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"is_open_day"</span>] <span class="op">=</span> df[<span class="st">"dow"</span>].isin(OPEN_DOW).astype(<span class="bu">int</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"is_closed_day"</span>] <span class="op">=</span> df[<span class="st">"dow"</span>].isin(CLOSED_DOW).astype(<span class="bu">int</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="co"># sanity checks: mutually exclusive and exhaustive</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">set</span>(df[<span class="st">"time_band"</span>].unique()) <span class="op">==</span> {<span class="st">"early_morning"</span>, <span class="st">"business_hours"</span>, <span class="st">"evening"</span>, <span class="st">"late_night"</span>}</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">int</span>((df[<span class="st">"is_open_day"</span>] <span class="op">+</span> df[<span class="st">"is_closed_day"</span>]).<span class="bu">min</span>()) <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">int</span>((df[<span class="st">"is_open_day"</span>] <span class="op">+</span> df[<span class="st">"is_closed_day"</span>]).<span class="bu">max</span>()) <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">"call_ts"</span>,<span class="st">"hour"</span>,<span class="st">"dow"</span>,<span class="st">"time_band"</span>,<span class="st">"is_open_day"</span>,<span class="st">"is_closed_day"</span>]].head(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="82">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">call_ts</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">dow</th>
<th data-quarto-table-cell-role="th">time_band</th>
<th data-quarto-table-cell-role="th">is_open_day</th>
<th data-quarto-table-cell-role="th">is_closed_day</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2022-01-01 16:03:01</td>
<td>16</td>
<td>5</td>
<td>business_hours</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2022-01-01 16:06:17</td>
<td>16</td>
<td>5</td>
<td>business_hours</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2022-01-01 19:08:44</td>
<td>19</td>
<td>5</td>
<td>evening</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2022-01-01 20:03:11</td>
<td>20</td>
<td>5</td>
<td>evening</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2022-01-02 14:22:44</td>
<td>14</td>
<td>6</td>
<td>business_hours</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="executive-summary-table-stakeholder-ready" class="level3" data-number="2.7">
<h3 data-number="2.7" class="anchored" data-anchor-id="executive-summary-table-stakeholder-ready"><span class="header-section-number">2.7</span> Executive summary table (stakeholder-ready)</h3>
<div id="072b856e" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>cat_col <span class="op">=</span> <span class="st">"category"</span> <span class="cf">if</span> <span class="st">"category"</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> pd.DataFrame({</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Metric"</span>: [</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Rows (calls)"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Columns"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Unique contacts (hashed)"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Timestamp parsable rate"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Timestamp range (min)"</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Timestamp range (max)"</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Duration numeric rate"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Duplicate rows"</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Category column present?"</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Category non-null rate (if present)"</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Data readiness score (ts &amp; dur)"</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Value"</span>: [</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">int</span>(df.shape[<span class="dv">0</span>]),</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">int</span>(df.shape[<span class="dv">1</span>]),</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">int</span>(df[<span class="st">"contact_id"</span>].nunique()),</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'call_ts'</span>]<span class="sc">.</span>notna()<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">"</span>,</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">str</span>(df[<span class="st">"call_ts"</span>].<span class="bu">min</span>()),</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">str</span>(df[<span class="st">"call_ts"</span>].<span class="bu">max</span>()),</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'dur_sec'</span>]<span class="sc">.</span>notna()<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">"</span>,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">int</span>(df.duplicated().<span class="bu">sum</span>()),</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">bool</span>(cat_col <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>),</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>df[cat_col]<span class="sc">.</span>notna()<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">"</span> <span class="cf">if</span> cat_col <span class="cf">else</span> <span class="st">"N/A"</span>,</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'call_ts'</span>].notna() <span class="op">&amp;</span> df[<span class="st">'dur_sec'</span>].notna())<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">"</span>,</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="83">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Metric</th>
<th data-quarto-table-cell-role="th">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Rows (calls)</td>
<td>24952</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Columns</td>
<td>17</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Unique contacts (hashed)</td>
<td>2091</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Timestamp parsable rate</td>
<td>1.000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Timestamp range (min)</td>
<td>2022-01-01 16:03:01</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Timestamp range (max)</td>
<td>2024-10-04 20:15:16</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Duration numeric rate</td>
<td>1.000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Duplicate rows</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>Category column present?</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>Category non-null rate (if present)</td>
<td>1.000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>Data readiness score (ts &amp; dur)</td>
<td>1.000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="visual-1-monthly-call-volume-coverage" class="level3" data-number="2.8">
<h3 data-number="2.8" class="anchored" data-anchor-id="visual-1-monthly-call-volume-coverage"><span class="header-section-number">2.8</span> Visual 1 — Monthly call volume (coverage)</h3>
<div id="b98e9aaa" class="cell" data-execution_count="15">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="walsoft_contact_segmentation_files/figure-html/cell-16-output-1.png" width="662" height="470" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="84">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">month_id</th>
<th data-quarto-table-cell-role="th">n_calls</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">22</th>
<td>2023-11</td>
<td>627</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">23</th>
<td>2023-12</td>
<td>691</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>2024-01</td>
<td>944</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">25</th>
<td>2024-02</td>
<td>608</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">26</th>
<td>2024-03</td>
<td>783</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>2024-04</td>
<td>516</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">28</th>
<td>2024-05</td>
<td>165</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">29</th>
<td>2024-06</td>
<td>1034</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">30</th>
<td>2024-07</td>
<td>1049</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">31</th>
<td>2024-08</td>
<td>193</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">32</th>
<td>2024-09</td>
<td>107</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">33</th>
<td>2024-10</td>
<td>128</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="visual-2-duration-distribution-outlier-awareness" class="level3" data-number="2.9">
<h3 data-number="2.9" class="anchored" data-anchor-id="visual-2-duration-distribution-outlier-awareness"><span class="header-section-number">2.9</span> Visual 2 — Duration distribution (outlier awareness)</h3>
<div id="8a581bc0" class="cell" data-execution_count="16">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="walsoft_contact_segmentation_files/figure-html/cell-17-output-1.png" width="662" height="470" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="walsoft_contact_segmentation_files/figure-html/cell-17-output-2.png" width="662" height="470" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="85">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">duration_seconds</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0.00</th>
<td>1.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">0.25</th>
<td>9.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">0.50</th>
<td>34.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">0.75</th>
<td>84.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">0.90</th>
<td>211.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">0.95</th>
<td>396.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">0.99</th>
<td>1273.98</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1.00</th>
<td>7200.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="visual-3-time-band-mix-openclosed-day-mix-hard-constraint-diagnostics" class="level3" data-number="2.10">
<h3 data-number="2.10" class="anchored" data-anchor-id="visual-3-time-band-mix-openclosed-day-mix-hard-constraint-diagnostics"><span class="header-section-number">2.10</span> Visual 3 — Time-band mix + open/closed-day mix (hard-constraint diagnostics)</h3>
<div id="df70d8e8" class="cell" data-execution_count="17">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="walsoft_contact_segmentation_files/figure-html/cell-18-output-1.png" width="662" height="470" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="walsoft_contact_segmentation_files/figure-html/cell-18-output-2.png" width="662" height="470" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>(                n_calls
 time_band              
 business_hours    20624
 early_morning      1071
 evening            2877
 late_night          380,
                     n_calls
 is_closed_day              
 Open day (Mon–Sat)    23300
 Closed day (Sun)       1652)</code></pre>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Phase 1 — Audit summary (stakeholder-ready)
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Dataset health (ready for segmentation):</strong></p>
<ul>
<li><strong>24,952 call records</strong> across <strong>2,091 unique contacts</strong> (hashed).</li>
<li><strong>Time coverage:</strong> 2022-01-01 → 2024-10-04 (timestamps parse perfectly; durations fully numeric).</li>
<li><strong>No duplicates</strong> detected; <strong>category is fully populated</strong>.</li>
<li><strong>Data readiness score = 1.000</strong> (timestamp + duration fully usable).</li>
</ul>
<p><strong>Behavioral signals visible already:</strong></p>
<ul>
<li>Calls concentrate in <strong>business hours</strong> (20,624 / 24,952 ≈ 82.7%).</li>
<li>Smaller but meaningful activity in <strong>evening</strong> (2,877 ≈ 11.5%) and <strong>early morning</strong> (1,071 ≈ 4.3%); <strong>late night</strong> is rare (380 ≈ 1.5%).</li>
<li>Most calls happen on <strong>open days (Mon–Sat)</strong> (23,300 ≈ 93.4%); <strong>Sunday</strong> exists but is limited (1,652 ≈ 6.6%).</li>
</ul>
<p><strong>Duration profile (important for feature design):</strong></p>
<ul>
<li>Typical call is short: median <strong>34s</strong>, 75th percentile <strong>84s</strong>.</li>
<li>Heavy tail: 99th percentile <strong>~1,274s</strong>, max <strong>7,200s</strong> (2 hours) → we will use <strong>robust statistics</strong> (median, IQR, log transforms, and long-call share) instead of relying only on means.</li>
</ul>
<p><strong>Coverage caution (modeling hygiene):</strong></p>
<ul>
<li>Monthly volume is broadly stable until mid-2024, then shows sharp drops in some late months.</li>
<li>We will treat this as <strong>coverage/behavior regime change</strong> and rely on <strong>contact-level aggregates + recency</strong> (not month-level trends) for clustering.</li>
</ul>
<section id="transition-to-phase-2" class="level3" data-number="2.11">
<h3 data-number="2.11" class="anchored" data-anchor-id="transition-to-phase-2"><span class="header-section-number">2.11</span> Transition to Phase 2</h3>
<p>Next, we convert the call-level table into a <strong>contact-level feature table</strong> (1 row per contact).<br>
This is the modeling dataset for clustering.</p>
</section>
</div>
</div>
<hr>
</section>
</section>
<section id="phase-2-contact-level-features" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="phase-2-contact-level-features"><span class="header-section-number">3</span> Phase 2 — Contact-level features</h2>
<p>This phase transforms the <strong>call-level dataset</strong> into a <strong>contact-level feature table</strong>, producing <strong>one row per contact</strong>. These features capture activity intensity, temporal patterns, and category distributions, forming the basis for clustering and behavioral segmentation.</p>
<hr>
<section id="guardrails-setup" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="guardrails-setup"><span class="header-section-number">3.1</span> Guardrails &amp; Setup</h3>
<p>We first ensure all required columns from Phase 1 exist. This prevents accidental execution on incomplete data.</p>
<div id="81eda818" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Guardrails: ensure critical columns exist</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="st">"contact_id"</span> <span class="kw">in</span> df.columns, <span class="st">"contact_id missing (run Phase 1 first)."</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="st">"call_ts"</span> <span class="kw">in</span> df.columns, <span class="st">"call_ts missing (run Phase 1 first)."</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="st">"dur_sec"</span> <span class="kw">in</span> df.columns, <span class="st">"dur_sec missing (run Phase 1 first)."</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="st">"time_band"</span> <span class="kw">in</span> df.columns, <span class="st">"time_band missing (run Phase 1 first)."</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="st">"is_open_day"</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">"is_closed_day"</span> <span class="kw">in</span> df.columns, <span class="st">"open/closed flags missing."</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Helper for safe division (avoids division by zero):</p>
<div id="d3f0d75e" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> safe_div(a, b):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.where(b <span class="op">==</span> <span class="dv">0</span>, <span class="fl">0.0</span>, a <span class="op">/</span> b)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Reference timestamp for recency calculations:</p>
<div id="1bc8e1f2" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ASOF_TS <span class="op">=</span> df[<span class="st">"call_ts"</span>].<span class="bu">max</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="base-aggregations" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="base-aggregations"><span class="header-section-number">3.2</span> Base Aggregations</h3>
<p>Compute <strong>core contact-level metrics</strong>: total calls, active days, duration statistics, and recency/tenure measures.</p>
<div id="7ad362f5" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> df.groupby(<span class="st">"contact_id"</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> g.agg(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    n_calls<span class="op">=</span>(<span class="st">"call_ts"</span>, <span class="st">"size"</span>),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    n_days_active<span class="op">=</span>(<span class="st">"call_ts"</span>, <span class="kw">lambda</span> x: x.dt.date.nunique()),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    first_call_ts<span class="op">=</span>(<span class="st">"call_ts"</span>, <span class="st">"min"</span>),</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    last_call_ts<span class="op">=</span>(<span class="st">"call_ts"</span>, <span class="st">"max"</span>),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    total_dur_sec<span class="op">=</span>(<span class="st">"dur_sec"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    mean_dur_sec<span class="op">=</span>(<span class="st">"dur_sec"</span>, <span class="st">"mean"</span>),</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    median_dur_sec<span class="op">=</span>(<span class="st">"dur_sec"</span>, <span class="st">"median"</span>),</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    p90_dur_sec<span class="op">=</span>(<span class="st">"dur_sec"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.90</span>)),</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Recency and tenure (days)</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>base[<span class="st">"recency_days"</span>] <span class="op">=</span> (ASOF_TS <span class="op">-</span> base[<span class="st">"last_call_ts"</span>]).dt.total_seconds() <span class="op">/</span> (<span class="dv">24</span> <span class="op">*</span> <span class="dv">3600</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>base[<span class="st">"tenure_days"</span>] <span class="op">=</span> (base[<span class="st">"last_call_ts"</span>] <span class="op">-</span> base[<span class="st">"first_call_ts"</span>]).dt.total_seconds() <span class="op">/</span> (<span class="dv">24</span> <span class="op">*</span> <span class="dv">3600</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Call rates</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>base[<span class="st">"calls_per_active_day"</span>] <span class="op">=</span> safe_div(base[<span class="st">"n_calls"</span>], base[<span class="st">"n_days_active"</span>])</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>base[<span class="st">"calls_per_tenure_day"</span>] <span class="op">=</span> safe_div(base[<span class="st">"n_calls"</span>], (base[<span class="st">"tenure_days"</span>] <span class="op">+</span> <span class="fl">1.0</span>))</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Log transforms to stabilize heavy-tailed distributions</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>base[<span class="st">"log_n_calls"</span>] <span class="op">=</span> np.log1p(base[<span class="st">"n_calls"</span>])</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>base[<span class="st">"log_total_dur"</span>] <span class="op">=</span> np.log1p(base[<span class="st">"total_dur_sec"</span>])</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>base[<span class="st">"log_median_dur"</span>] <span class="op">=</span> np.log1p(base[<span class="st">"median_dur_sec"</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="long-call-share" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="long-call-share"><span class="header-section-number">3.3</span> Long-call Share</h3>
<p>Define <strong>long calls</strong> as those exceeding the 95th percentile. Compute each contact’s share of long calls to capture <strong>tail behavior</strong>.</p>
<div id="7d5a8874" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>LONG_CALL_THRESHOLD <span class="op">=</span> <span class="bu">float</span>(df[<span class="st">"dur_sec"</span>].quantile(<span class="fl">0.95</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"_is_long_call"</span>] <span class="op">=</span> (df[<span class="st">"dur_sec"</span>] <span class="op">&gt;=</span> LONG_CALL_THRESHOLD).astype(<span class="bu">int</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>long_share <span class="op">=</span> (</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    df.groupby(<span class="st">"contact_id"</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>      .agg(long_call_share<span class="op">=</span>(<span class="st">"_is_long_call"</span>, <span class="st">"mean"</span>))</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="time-band-mix" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="time-band-mix"><span class="header-section-number">3.4</span> Time-Band Mix</h3>
<p>Contacts may have different temporal activity patterns. We compute <strong>proportions of calls per time band</strong> (business hours, evening, late night, early morning).</p>
<div id="1226f28c" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>band_mix <span class="op">=</span> (</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    pd.crosstab(df[<span class="st">"contact_id"</span>], df[<span class="st">"time_band"</span>], normalize<span class="op">=</span><span class="st">"index"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>      .reset_index()</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>      .rename(columns<span class="op">=</span>{</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">"business_hours"</span>: <span class="st">"share_business_hours"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>          <span class="st">"evening"</span>: <span class="st">"share_evening"</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>          <span class="st">"late_night"</span>: <span class="st">"share_late_night"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">"early_morning"</span>: <span class="st">"share_early_morning"</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure all expected columns exist</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"share_business_hours"</span>,<span class="st">"share_evening"</span>,<span class="st">"share_late_night"</span>,<span class="st">"share_early_morning"</span>]:</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> band_mix.columns:</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        band_mix[col] <span class="op">=</span> <span class="fl">0.0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="open-vs-closed-day-mix" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="open-vs-closed-day-mix"><span class="header-section-number">3.5</span> Open vs Closed Day Mix</h3>
<p>Capture <strong>day-of-week activity patterns</strong>. Open vs.&nbsp;closed days are mutually exclusive and sum to 1 per contact.</p>
<div id="ebfe45a3" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>day_mix <span class="op">=</span> (</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    df.groupby(<span class="st">"contact_id"</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>      .agg(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>          share_open_day<span class="op">=</span>(<span class="st">"is_open_day"</span>, <span class="st">"mean"</span>),</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>          share_closed_day<span class="op">=</span>(<span class="st">"is_closed_day"</span>, <span class="st">"mean"</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Sanity check</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>day_mix[<span class="st">"_sum"</span>] <span class="op">=</span> day_mix[<span class="st">"share_open_day"</span>] <span class="op">+</span> day_mix[<span class="st">"share_closed_day"</span>]</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> np.allclose(day_mix[<span class="st">"_sum"</span>], <span class="fl">1.0</span>, atol<span class="op">=</span><span class="fl">1e-9</span>), <span class="st">"Open+Closed shares not summing to 1."</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>day_mix <span class="op">=</span> day_mix.drop(columns<span class="op">=</span>[<span class="st">"_sum"</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="category-mix-optional" class="level3" data-number="3.6">
<h3 data-number="3.6" class="anchored" data-anchor-id="category-mix-optional"><span class="header-section-number">3.6</span> Category Mix (Optional)</h3>
<p>For interpretation, compute the <strong>top-K category proportions per contact</strong>, preserving sparsity and numeric representation.</p>
<div id="0abc961a" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>TOPK <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>top_categories <span class="op">=</span> df[<span class="st">"category"</span>].value_counts().head(TOPK).index.tolist()</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>cat_tab <span class="op">=</span> (</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    pd.crosstab(df[<span class="st">"contact_id"</span>], df[<span class="st">"category"</span>])</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>      .reindex(columns<span class="op">=</span>top_categories, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to proportions</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>cat_mix <span class="op">=</span> (cat_tab.div(cat_tab.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>).replace(<span class="dv">0</span>, <span class="dv">1</span>), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>                 .reset_index()</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>                 .rename(columns<span class="op">=</span>{c: <span class="ss">f"share_cat_</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> c <span class="kw">in</span> top_categories}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="merge-all-features" class="level3" data-number="3.7">
<h3 data-number="3.7" class="anchored" data-anchor-id="merge-all-features"><span class="header-section-number">3.7</span> Merge All Features</h3>
<p>Combine <strong>base, long-call, time-band, day-mix, and category features</strong> into a single contact-level table.</p>
<div id="21cf01f6" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>contact_features <span class="op">=</span> (</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    base.merge(long_share, on<span class="op">=</span><span class="st">"contact_id"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>        .merge(band_mix, on<span class="op">=</span><span class="st">"contact_id"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        .merge(day_mix, on<span class="op">=</span><span class="st">"contact_id"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        .merge(cat_mix, on<span class="op">=</span><span class="st">"contact_id"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill any leftover NaNs</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>num_cols <span class="op">=</span> contact_features.select_dtypes(include<span class="op">=</span>[np.number]).columns</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>contact_features[num_cols] <span class="op">=</span> contact_features[num_cols].fillna(<span class="fl">0.0</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Preview</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"contact_features.shape ="</span>, contact_features.shape)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Long-call threshold (95th pct, seconds) ="</span>, LONG_CALL_THRESHOLD)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>contact_features.head(<span class="dv">5</span>).T</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>contact_features.shape = (2091, 28)
Long-call threshold (95th pct, seconds) = 396.0</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="95">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">contact_id</th>
<td>00047e187745</td>
<td>000d71073f3e</td>
<td>001c36642ecb</td>
<td>00ad9a0b1291</td>
<td>00ed0d18f9e3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">n_calls</th>
<td>1</td>
<td>905</td>
<td>6</td>
<td>1</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">n_days_active</th>
<td>1</td>
<td>384</td>
<td>4</td>
<td>1</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">first_call_ts</th>
<td>2024-03-22 17:01:05</td>
<td>2022-01-03 08:26:21</td>
<td>2022-07-24 20:33:20</td>
<td>2023-06-01 15:28:13</td>
<td>2023-12-08 19:38:04</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">last_call_ts</th>
<td>2024-03-22 17:01:05</td>
<td>2024-09-28 15:01:13</td>
<td>2024-10-01 14:11:06</td>
<td>2023-06-01 15:28:13</td>
<td>2023-12-09 07:36:06</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">total_dur_sec</th>
<td>43</td>
<td>44383</td>
<td>564</td>
<td>239</td>
<td>232</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mean_dur_sec</th>
<td>43.0</td>
<td>49.041989</td>
<td>94.0</td>
<td>239.0</td>
<td>116.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">median_dur_sec</th>
<td>43.0</td>
<td>22.0</td>
<td>59.0</td>
<td>239.0</td>
<td>116.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">p90_dur_sec</th>
<td>43.0</td>
<td>99.0</td>
<td>201.0</td>
<td>239.0</td>
<td>139.2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">recency_days</th>
<td>196.13485</td>
<td>6.21809</td>
<td>3.252894</td>
<td>491.19934</td>
<td>300.527199</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">tenure_days</th>
<td>0.0</td>
<td>999.274213</td>
<td>799.73456</td>
<td>0.0</td>
<td>0.498634</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">calls_per_active_day</th>
<td>1.0</td>
<td>2.356771</td>
<td>1.5</td>
<td>1.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">calls_per_tenure_day</th>
<td>1.0</td>
<td>0.904752</td>
<td>0.007493</td>
<td>1.0</td>
<td>1.334548</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">log_n_calls</th>
<td>0.693147</td>
<td>6.809039</td>
<td>1.94591</td>
<td>0.693147</td>
<td>1.098612</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">log_total_dur</th>
<td>3.78419</td>
<td>10.700634</td>
<td>6.336826</td>
<td>5.480639</td>
<td>5.451038</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">log_median_dur</th>
<td>3.78419</td>
<td>3.135494</td>
<td>4.094345</td>
<td>5.480639</td>
<td>4.762174</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">long_call_share</th>
<td>0.0</td>
<td>0.009945</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_business_hours</th>
<td>1.0</td>
<td>0.923757</td>
<td>0.833333</td>
<td>1.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_early_morning</th>
<td>0.0</td>
<td>0.028729</td>
<td>0.0</td>
<td>0.0</td>
<td>0.5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_evening</th>
<td>0.0</td>
<td>0.047514</td>
<td>0.166667</td>
<td>0.0</td>
<td>0.5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_late_night</th>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_open_day</th>
<td>1.0</td>
<td>0.967956</td>
<td>0.666667</td>
<td>1.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_closed_day</th>
<td>0.0</td>
<td>0.032044</td>
<td>0.333333</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_cat_Unknown</th>
<td>1.0</td>
<td>1.0</td>
<td>1.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_cat_Family</th>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_cat_Supplier</th>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_cat_Important Contacts</th>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_cat_Service Provider</th>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="quick-feature-audit" class="level3" data-number="3.8">
<h3 data-number="3.8" class="anchored" data-anchor-id="quick-feature-audit"><span class="header-section-number">3.8</span> Quick Feature Audit</h3>
<p>Sanity check <strong>feature completeness and distribution</strong>.</p>
<div id="6150040c" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>feature_audit <span class="op">=</span> pd.DataFrame({</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_contacts"</span>: [<span class="bu">int</span>(contact_features.shape[<span class="dv">0</span>])],</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_features_total"</span>: [<span class="bu">int</span>(contact_features.shape[<span class="dv">1</span>])],</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"any_missing_numeric"</span>: [<span class="bu">bool</span>(contact_features.select_dtypes(include<span class="op">=</span>[np.number]).isna().<span class="bu">any</span>().<span class="bu">any</span>())],</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"min_calls"</span>: [<span class="bu">int</span>(contact_features[<span class="st">"n_calls"</span>].<span class="bu">min</span>())],</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"median_calls"</span>: [<span class="bu">float</span>(contact_features[<span class="st">"n_calls"</span>].median())],</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_calls"</span>: [<span class="bu">int</span>(contact_features[<span class="st">"n_calls"</span>].<span class="bu">max</span>())],</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"median_recency_days"</span>: [<span class="bu">float</span>(contact_features[<span class="st">"recency_days"</span>].median())],</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>feature_audit</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="96">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_contacts</th>
<th data-quarto-table-cell-role="th">n_features_total</th>
<th data-quarto-table-cell-role="th">any_missing_numeric</th>
<th data-quarto-table-cell-role="th">min_calls</th>
<th data-quarto-table-cell-role="th">median_calls</th>
<th data-quarto-table-cell-role="th">max_calls</th>
<th data-quarto-table-cell-role="th">median_recency_days</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2091</td>
<td>28</td>
<td>False</td>
<td>1</td>
<td>2.0</td>
<td>2413</td>
<td>445.260324</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="top-activity-contacts" class="level3" data-number="3.9">
<h3 data-number="3.9" class="anchored" data-anchor-id="top-activity-contacts"><span class="header-section-number">3.9</span> Top Activity Contacts</h3>
<p>Inspect <strong>most active contacts</strong> without exposing raw identifiers. This helps validate engineered features and distribution of behavioral metrics.</p>
<div id="d9ea2d47" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>top_activity <span class="op">=</span> contact_features.sort_values(<span class="st">"n_calls"</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">10</span>)[</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"contact_id"</span>,<span class="st">"n_calls"</span>,<span class="st">"n_days_active"</span>,<span class="st">"total_dur_sec"</span>,<span class="st">"median_dur_sec"</span>,<span class="st">"recency_days"</span>,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>     <span class="st">"share_business_hours"</span>,<span class="st">"share_evening"</span>,<span class="st">"share_early_morning"</span>,<span class="st">"share_late_night"</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>     <span class="st">"share_open_day"</span>,<span class="st">"share_closed_day"</span>,<span class="st">"long_call_share"</span>]</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>top_activity.T</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="97">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">900</th>
<th data-quarto-table-cell-role="th">1026</th>
<th data-quarto-table-cell-role="th">572</th>
<th data-quarto-table-cell-role="th">1103</th>
<th data-quarto-table-cell-role="th">1959</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">791</th>
<th data-quarto-table-cell-role="th">1885</th>
<th data-quarto-table-cell-role="th">675</th>
<th data-quarto-table-cell-role="th">1147</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">contact_id</th>
<td>70ac660de5a1</td>
<td>8080cfddc014</td>
<td>497ce042ecb8</td>
<td>88d17d0474e5</td>
<td>f2f949ce03e7</td>
<td>000d71073f3e</td>
<td>632b8c0f82f4</td>
<td>eb0aeed50ff6</td>
<td>550412a925c4</td>
<td>8d6e4e8282d5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">n_calls</th>
<td>2413</td>
<td>1473</td>
<td>1272</td>
<td>1077</td>
<td>917</td>
<td>905</td>
<td>756</td>
<td>477</td>
<td>421</td>
<td>369</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">n_days_active</th>
<td>606</td>
<td>592</td>
<td>433</td>
<td>447</td>
<td>398</td>
<td>384</td>
<td>307</td>
<td>97</td>
<td>180</td>
<td>186</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">total_dur_sec</th>
<td>120519</td>
<td>192181</td>
<td>74136</td>
<td>222060</td>
<td>186933</td>
<td>44383</td>
<td>77638</td>
<td>25168</td>
<td>23209</td>
<td>102636</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">median_dur_sec</th>
<td>28.0</td>
<td>48.0</td>
<td>12.0</td>
<td>76.0</td>
<td>32.0</td>
<td>22.0</td>
<td>32.0</td>
<td>36.0</td>
<td>40.0</td>
<td>75.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">recency_days</th>
<td>59.330243</td>
<td>4.232801</td>
<td>0.029317</td>
<td>0.124444</td>
<td>158.600069</td>
<td>6.21809</td>
<td>1.081655</td>
<td>59.142512</td>
<td>2.317778</td>
<td>63.253345</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_business_hours</th>
<td>0.822213</td>
<td>0.680244</td>
<td>0.672956</td>
<td>0.733519</td>
<td>0.72301</td>
<td>0.923757</td>
<td>0.727513</td>
<td>0.953878</td>
<td>0.973872</td>
<td>0.731707</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_evening</th>
<td>0.116453</td>
<td>0.170401</td>
<td>0.279088</td>
<td>0.163417</td>
<td>0.202835</td>
<td>0.047514</td>
<td>0.187831</td>
<td>0.033543</td>
<td>0.021378</td>
<td>0.186992</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_early_morning</th>
<td>0.033154</td>
<td>0.127631</td>
<td>0.038522</td>
<td>0.077994</td>
<td>0.061069</td>
<td>0.028729</td>
<td>0.064815</td>
<td>0.0</td>
<td>0.002375</td>
<td>0.04878</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_late_night</th>
<td>0.028181</td>
<td>0.021724</td>
<td>0.009434</td>
<td>0.02507</td>
<td>0.013086</td>
<td>0.0</td>
<td>0.019841</td>
<td>0.012579</td>
<td>0.002375</td>
<td>0.03252</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_open_day</th>
<td>0.930792</td>
<td>0.901561</td>
<td>0.956761</td>
<td>0.889508</td>
<td>0.876772</td>
<td>0.967956</td>
<td>0.915344</td>
<td>0.960168</td>
<td>0.980998</td>
<td>0.864499</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_closed_day</th>
<td>0.069208</td>
<td>0.098439</td>
<td>0.043239</td>
<td>0.110492</td>
<td>0.123228</td>
<td>0.032044</td>
<td>0.084656</td>
<td>0.039832</td>
<td>0.019002</td>
<td>0.135501</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">long_call_share</th>
<td>0.008288</td>
<td>0.076035</td>
<td>0.017296</td>
<td>0.138347</td>
<td>0.139586</td>
<td>0.009945</td>
<td>0.047619</td>
<td>0.002096</td>
<td>0.004751</td>
<td>0.195122</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Phase 2 — Stakeholder-ready summary (what we learned)
</div>
</div>
<div class="callout-body-container callout-body">
<p>We successfully converted <strong>24,952 calls</strong> into a <strong>contact-level modeling table</strong> with <strong>2,091 contacts</strong> and <strong>28 features</strong>.</p>
<section id="what-the-phase-2-feature-table-represents-business-meaning" class="level3" data-number="3.10">
<h3 data-number="3.10" class="anchored" data-anchor-id="what-the-phase-2-feature-table-represents-business-meaning"><span class="header-section-number">3.10</span> What the Phase 2 feature table represents (business meaning)</h3>
<p>Each row is a <strong>contact</strong> (hashed ID), and the features capture:</p>
<ul>
<li><strong>Volume / intensity:</strong> <code>n_calls</code>, <code>n_days_active</code>, <code>calls_per_active_day</code>, <code>calls_per_tenure_day</code></li>
<li><strong>Relationship depth / effort proxy:</strong> <code>total_dur_sec</code>, <code>median_dur_sec</code>, <code>p90_dur_sec</code>, plus log versions</li>
<li><strong>Recency / dormancy risk:</strong> <code>recency_days</code> (how long since last call)</li>
<li><strong>Time preference / accessibility:</strong> shares by time band (business/evening/early/late)</li>
<li><strong>Open vs closed day behavior:</strong> <code>share_open_day</code>, <code>share_closed_day</code></li>
<li><strong>Tail behavior:</strong> <code>long_call_share</code> where “long” is <strong>≥ 396s</strong> (95th percentile)</li>
<li><strong>Category mix (interpretation aid):</strong> proportions of top-8 categories per contact</li>
</ul>
</section>
<section id="sanity-checks-passed-safe-to-proceed" class="level3" data-number="3.11">
<h3 data-number="3.11" class="anchored" data-anchor-id="sanity-checks-passed-safe-to-proceed"><span class="header-section-number">3.11</span> Sanity checks passed (safe to proceed)</h3>
<ul>
<li>No missing numeric values in engineered features.</li>
<li>Open + closed day shares sum to 1 per contact (validated).</li>
<li>Time-band shares exist for every contact (columns ensured even if 0).</li>
</ul>
</section>
<section id="what-the-results-already-hint-at-without-clustering-yet" class="level3" data-number="3.12">
<h3 data-number="3.12" class="anchored" data-anchor-id="what-the-results-already-hint-at-without-clustering-yet"><span class="header-section-number">3.12</span> What the results already hint at (without clustering yet)</h3>
<ul>
<li><strong>Highly skewed activity:</strong> median contact has <strong>2 calls</strong>, but the top contact has <strong>2,413</strong> calls → we must <strong>scale/transform</strong> before K-means.</li>
<li><strong>Recency is large for many contacts:</strong> median <code>recency_days ≈ 445</code> → many contacts are dormant; segmentation must separate “active” vs “inactive”.</li>
<li>Top activity contacts show diverse patterns:
<ul>
<li>some are high-volume but mostly business hours</li>
<li>some show meaningful evening/early activity</li>
<li>some have high <code>long_call_share</code> (deep conversations or issue resolution)</li>
</ul></li>
</ul>
</section>
<section id="modeling-implication" class="level3" data-number="3.13">
<h3 data-number="3.13" class="anchored" data-anchor-id="modeling-implication"><span class="header-section-number">3.13</span> Modeling implication</h3>
<p>At this point we have a <strong>contact-level feature table</strong> with strong business meaning (volume, duration, recency, timing).<br>
Before clustering, we must build a <strong>clean clustering matrix</strong> <span class="math inline">\(X\)</span> so distance-based algorithms behave correctly.</p>
<p>We will build <span class="math inline">\(X\)</span> such that it:</p>
<ol type="1">
<li><strong>Excludes non-model columns</strong>
<ul>
<li>No timestamps (<code>first_call_ts</code>, <code>last_call_ts</code>) and no raw identifiers.<br>
</li>
<li>Category mix is kept for interpretation, but excluded from default training to avoid “baking in labels”.</li>
</ul></li>
<li><strong>Controls heavy tails and near-constant features</strong>
<ul>
<li>Phone-call behavior is highly skewed (a few contacts dominate calls/duration).<br>
</li>
<li>We apply robust transforms already engineered (log features) and use a <em>robust preprocessing pipeline</em>.<br>
</li>
<li>We also drop <strong>near-constant (IQR≈0) features</strong> to avoid unstable scaling and distance domination.</li>
</ul></li>
<li><strong>Scales fairly for distance-based clustering</strong>
<ul>
<li>We use <strong>median imputation</strong> (robust, future-proof if new features introduce missingness).<br>
</li>
<li>We use <strong>RobustScaler (median/IQR)</strong> instead of StandardScaler to reduce outlier influence.</li>
</ul></li>
</ol>
<hr>
</section>
<section id="transition" class="level3" data-number="3.14">
<h3 data-number="3.14" class="anchored" data-anchor-id="transition"><span class="header-section-number">3.14</span> Transition</h3>
<p>Phase 3 converts <code>contact_features</code> into <strong>clustering-ready inputs</strong> and produces:</p>
<ul>
<li>a <strong>feature-block dictionary</strong> for later sensitivity tests (volume vs duration vs timing vs recency),</li>
<li>a cleaned, scaled matrix <strong><code>X</code></strong> and aligned <strong><code>feature_names</code></strong> for reproducibility and interpretation.</li>
</ul>
</section>
</div>
</div>
<hr>
</section>
</section>
<section id="phase-3-preprocess-bullet-proof-distance-based-clustering-ready" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="phase-3-preprocess-bullet-proof-distance-based-clustering-ready"><span class="header-section-number">4</span> Phase 3 — Preprocess (bullet-proof, distance-based clustering ready)</h2>
<p>This phase prepares the <strong>contact-level feature table</strong> for distance-based clustering by producing a stable numeric matrix <strong><code>X</code></strong> (rows = contacts, columns = standardized features).</p>
<p>We do four things:</p>
<ol type="1">
<li><strong>Define feature blocks</strong> (auditable and reusable for sensitivity tests later)<br>
</li>
<li><strong>Build the default model matrix</strong> (exclude timestamps and category mix by default)<br>
</li>
<li><strong>Stabilize heavy tails</strong> (clip extreme values in raw space)<br>
</li>
<li><strong>Impute + robust-scale</strong> (median imputation + RobustScaler) with diagnostics</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Why RobustScaler (not StandardScaler)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Contact behaviour is heavy-tailed (a few contacts dominate activity).<br>
Distance-based clustering is scale-sensitive. <strong>RobustScaler uses median and IQR</strong>, reducing outlier influence and producing more stable distances.</p>
</div>
</div>
<hr>
<section id="freeze-an-interpretation-copy-read-only-view" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="freeze-an-interpretation-copy-read-only-view"><span class="header-section-number">4.1</span> Freeze an interpretation copy (read-only view)</h3>
<div id="90b33faf" class="cell" data-execution_count="29">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>contact_features_view <span class="op">=</span> contact_features.copy()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="define-feature-blocks-for-interpretation-and-sensitivity-analysis" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="define-feature-blocks-for-interpretation-and-sensitivity-analysis"><span class="header-section-number">4.2</span> Define feature blocks (for interpretation and sensitivity analysis)</h3>
<div id="da951564" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> RobustScaler</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="227c1d69" class="cell" data-execution_count="31">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature blocks (business meaning)</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>volume_features <span class="op">=</span> [</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_calls"</span>, <span class="st">"n_days_active"</span>, <span class="st">"calls_per_active_day"</span>, <span class="st">"calls_per_tenure_day"</span>, <span class="st">"log_n_calls"</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>duration_features <span class="op">=</span> [</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_dur_sec"</span>, <span class="st">"mean_dur_sec"</span>, <span class="st">"median_dur_sec"</span>, <span class="st">"p90_dur_sec"</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"log_total_dur"</span>, <span class="st">"log_median_dur"</span>, <span class="st">"long_call_share"</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>recency_features <span class="op">=</span> [</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"recency_days"</span>, <span class="st">"tenure_days"</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>timing_features <span class="op">=</span> [</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"share_business_hours"</span>, <span class="st">"share_evening"</span>, <span class="st">"share_early_morning"</span>, <span class="st">"share_late_night"</span>,</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"share_open_day"</span>, <span class="st">"share_closed_day"</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Category mix is useful for interpretation, but excluded from default model training</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>category_features <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> contact_features.columns <span class="cf">if</span> c.startswith(<span class="st">"share_cat_"</span>)]</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>FEATURE_BLOCKS <span class="op">=</span> {</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"volume"</span>: volume_features,</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"duration"</span>: duration_features,</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"recency"</span>: recency_features,</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"timing"</span>: timing_features,</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"category"</span>: category_features</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Validate engineered feature presence (hard gate)</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>missing <span class="op">=</span> {k: [f <span class="cf">for</span> f <span class="kw">in</span> v <span class="cf">if</span> f <span class="kw">not</span> <span class="kw">in</span> contact_features.columns] <span class="cf">for</span> k, v <span class="kw">in</span> FEATURE_BLOCKS.items()}</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>missing <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> missing.items() <span class="cf">if</span> <span class="bu">len</span>(v) <span class="op">&gt;</span> <span class="dv">0</span>}</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(missing) <span class="op">==</span> <span class="dv">0</span>, <span class="ss">f"Missing engineered features: </span><span class="sc">{</span>missing<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>FEATURE_BLOCKS</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>{'volume': ['n_calls',
  'n_days_active',
  'calls_per_active_day',
  'calls_per_tenure_day',
  'log_n_calls'],
 'duration': ['total_dur_sec',
  'mean_dur_sec',
  'median_dur_sec',
  'p90_dur_sec',
  'log_total_dur',
  'log_median_dur',
  'long_call_share'],
 'recency': ['recency_days', 'tenure_days'],
 'timing': ['share_business_hours',
  'share_evening',
  'share_early_morning',
  'share_late_night',
  'share_open_day',
  'share_closed_day'],
 'category': ['share_cat_Unknown',
  'share_cat_Family',
  'share_cat_Supplier',
  'share_cat_Important Contacts',
  'share_cat_Service Provider']}</code></pre>
</div>
</div>
<hr>
</section>
<section id="select-default-model-features-no-timestamps-no-category-mix-by-default" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="select-default-model-features-no-timestamps-no-category-mix-by-default"><span class="header-section-number">4.3</span> Select default model features (no timestamps, no category mix by default)</h3>
<p>We train clustering on behaviour (volume, duration, recency, timing). Category mix stays available for interpretation and later sensitivity checks.</p>
<div id="2d74d4d8" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>MODEL_FEATURES <span class="op">=</span> (</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    FEATURE_BLOCKS[<span class="st">"volume"</span>]</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> FEATURE_BLOCKS[<span class="st">"duration"</span>]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> FEATURE_BLOCKS[<span class="st">"recency"</span>]</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> FEATURE_BLOCKS[<span class="st">"timing"</span>]</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>X_raw <span class="op">=</span> contact_features[MODEL_FEATURES].copy()</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"X_raw.shape ="</span>, X_raw.shape)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>X_raw.shape = (2091, 20)</code></pre>
</div>
</div>
<hr>
</section>
<section id="diagnostics-before-preprocessing-missingness-inf-safety" class="level3" data-number="4.4">
<h3 data-number="4.4" class="anchored" data-anchor-id="diagnostics-before-preprocessing-missingness-inf-safety"><span class="header-section-number">4.4</span> Diagnostics before preprocessing (missingness + inf safety)</h3>
<div id="28fb828f" class="cell" data-execution_count="33">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Missingness inspection (future-proof if new features introduce NaNs)</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>miss <span class="op">=</span> X_raw.isna().<span class="bu">sum</span>().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>miss_table <span class="op">=</span> miss[miss <span class="op">&gt;</span> <span class="dv">0</span>].to_frame(<span class="st">"n_missing"</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>miss_table</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="102">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_missing</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
<div id="93708356" class="cell" data-execution_count="34">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inf / -Inf inspection (must not exist)</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>has_inf <span class="op">=</span> np.isinf(X_raw.to_numpy(dtype<span class="op">=</span><span class="bu">float</span>)).<span class="bu">any</span>()</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Any inf in X_raw:"</span>, <span class="bu">bool</span>(has_inf))</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> has_inf, <span class="st">"Infinite values detected in X_raw (must fix before scaling)."</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Any inf in X_raw: False</code></pre>
</div>
</div>
<hr>
</section>
<section id="stability-strategy-recommended-drop-only-truly-constant-columns-clip-extremes" class="level3" data-number="4.5">
<h3 data-number="4.5" class="anchored" data-anchor-id="stability-strategy-recommended-drop-only-truly-constant-columns-clip-extremes"><span class="header-section-number">4.5</span> Stability strategy (recommended): drop only truly constant columns + clip extremes</h3>
<p><strong>Important correction:</strong> Dropping “low IQR” features is too aggressive in contact data (many contacts have 1–2 calls, which makes shares look constant). Instead we:</p>
<ul>
<li>drop only <strong>truly constant</strong> columns (no information),</li>
<li>clip each feature to <strong>p01–p99</strong> in raw units (winsorization),</li>
<li>then apply RobustScaler.</li>
</ul>
<div id="f404b12b" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A) Drop truly constant columns only (no information)</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>nunique <span class="op">=</span> X_raw.nunique(dropna<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>constant_cols <span class="op">=</span> nunique[nunique <span class="op">&lt;=</span> <span class="dv">1</span>].index.tolist()</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Truly-constant cols (drop):"</span>, constant_cols)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>X_raw2 <span class="op">=</span> X_raw.drop(columns<span class="op">=</span>constant_cols) <span class="cf">if</span> constant_cols <span class="cf">else</span> X_raw.copy()</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># B) Clip extremes in RAW space to stabilize heavy tails</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>CLIP_LO <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>CLIP_HI <span class="op">=</span> <span class="fl">0.99</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>clip_info <span class="op">=</span> []</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>X_clip <span class="op">=</span> X_raw2.copy()</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> X_clip.columns:</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    lo <span class="op">=</span> <span class="bu">float</span>(X_clip[col].quantile(CLIP_LO))</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    hi <span class="op">=</span> <span class="bu">float</span>(X_clip[col].quantile(CLIP_HI))</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    X_clip[col] <span class="op">=</span> X_clip[col].clip(lower<span class="op">=</span>lo, upper<span class="op">=</span>hi)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    clip_info.append({<span class="st">"feature"</span>: col, <span class="st">"p01"</span>: lo, <span class="st">"p99"</span>: hi})</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>clip_table <span class="op">=</span> pd.DataFrame(clip_info).sort_values(<span class="st">"feature"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>X_clip.shape, clip_table.head(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Truly-constant cols (drop): []</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>((2091, 20),
                 feature       p01         p99
 0  calls_per_active_day  1.000000    5.000000
 1  calls_per_tenure_day  0.005871    4.028542
 2        log_median_dur  1.098612    6.634896
 3           log_n_calls  0.693147    5.153539
 4         log_total_dur  1.098612    9.842541
 5       long_call_share  0.000000    1.000000
 6          mean_dur_sec  2.000000  771.900000
 7        median_dur_sec  2.000000  760.200000
 8               n_calls  1.000000  172.300000
 9         n_days_active  1.000000   96.100000)</code></pre>
</div>
</div>
<hr>
</section>
<section id="median-imputation-robustscaler" class="level3" data-number="4.6">
<h3 data-number="4.6" class="anchored" data-anchor-id="median-imputation-robustscaler"><span class="header-section-number">4.6</span> Median imputation + RobustScaler</h3>
<div id="3abd7c9d" class="cell" data-execution_count="36">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Median imputation is robust (and future-proof for features that may introduce NaNs later)</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>imputer <span class="op">=</span> SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># RobustScaler uses median/IQR to reduce outlier influence</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> RobustScaler(with_centering<span class="op">=</span><span class="va">True</span>, with_scaling<span class="op">=</span><span class="va">True</span>, quantile_range<span class="op">=</span>(<span class="fl">25.0</span>, <span class="fl">75.0</span>))</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>X_imputed <span class="op">=</span> imputer.fit_transform(X_clip)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> scaler.fit_transform(X_imputed)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"X.shape ="</span>, X.shape)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Any NaN in X:"</span>, <span class="bu">bool</span>(np.isnan(X).<span class="bu">any</span>()))</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> np.isnan(X).<span class="bu">any</span>(), <span class="st">"NaNs remain after preprocessing (must fix)."</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"max_abs_after_scaling ="</span>, <span class="bu">float</span>(np.<span class="bu">max</span>(np.<span class="bu">abs</span>(X))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>X.shape = (2091, 20)
Any NaN in X: False
max_abs_after_scaling = 95.09999999999991</code></pre>
</div>
</div>
<hr>
</section>
<section id="diagnostics-identify-any-dominating-feature-in-scaled-space" class="level3" data-number="4.7">
<h3 data-number="4.7" class="anchored" data-anchor-id="diagnostics-identify-any-dominating-feature-in-scaled-space"><span class="header-section-number">4.7</span> Diagnostics: identify any dominating feature in scaled space</h3>
<p>If one feature still dominates distances, we detect it explicitly.</p>
<div id="1777d847" class="cell" data-execution_count="37">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>feature_names <span class="op">=</span> <span class="bu">list</span>(X_clip.columns)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>max_abs_by_feature <span class="op">=</span> np.<span class="bu">max</span>(np.<span class="bu">abs</span>(X), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>dominance <span class="op">=</span> (</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame({</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"feature"</span>: feature_names,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_abs_scaled"</span>: max_abs_by_feature,</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"raw_p01"</span>: clip_table.set_index(<span class="st">"feature"</span>).loc[feature_names, <span class="st">"p01"</span>].values,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"raw_p99"</span>: clip_table.set_index(<span class="st">"feature"</span>).loc[feature_names, <span class="st">"p99"</span>].values,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"raw_iqr"</span>: (X_raw2.quantile(<span class="fl">0.75</span>) <span class="op">-</span> X_raw2.quantile(<span class="fl">0.25</span>)).reindex(feature_names).values,</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_unique"</span>: X_raw2.nunique().reindex(feature_names).values</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"max_abs_scaled"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>dominance.head(<span class="dv">12</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="106">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">feature</th>
<th data-quarto-table-cell-role="th">max_abs_scaled</th>
<th data-quarto-table-cell-role="th">raw_p01</th>
<th data-quarto-table-cell-role="th">raw_p99</th>
<th data-quarto-table-cell-role="th">raw_iqr</th>
<th data-quarto-table-cell-role="th">n_unique</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>n_days_active</td>
<td>95.100000</td>
<td>1.000000</td>
<td>96.100000</td>
<td>1.000000</td>
<td>80</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>total_dur_sec</td>
<td>78.405858</td>
<td>2.000000</td>
<td>18830.000000</td>
<td>239.000000</td>
<td>706</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>n_calls</td>
<td>56.766667</td>
<td>1.000000</td>
<td>172.300000</td>
<td>3.000000</td>
<td>108</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>tenure_days</td>
<td>25.858679</td>
<td>0.000000</td>
<td>941.093146</td>
<td>36.393634</td>
<td>1108</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>p90_dur_sec</td>
<td>13.405819</td>
<td>2.000000</td>
<td>1375.100000</td>
<td>97.950000</td>
<td>1070</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>median_dur_sec</td>
<td>11.060536</td>
<td>2.000000</td>
<td>760.200000</td>
<td>65.250000</td>
<td>424</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>mean_dur_sec</td>
<td>10.365775</td>
<td>2.000000</td>
<td>771.900000</td>
<td>70.125000</td>
<td>920</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>log_n_calls</td>
<td>4.425372</td>
<td>0.693147</td>
<td>5.153539</td>
<td>0.916291</td>
<td>108</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>calls_per_active_day</td>
<td>4.000000</td>
<td>1.000000</td>
<td>5.000000</td>
<td>1.000000</td>
<td>170</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>calls_per_tenure_day</td>
<td>3.649338</td>
<td>0.005871</td>
<td>4.028542</td>
<td>0.829888</td>
<td>1116</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>log_total_dur</td>
<td>2.554233</td>
<td>1.098612</td>
<td>9.842541</td>
<td>2.083111</td>
<td>706</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>log_median_dur</td>
<td>1.706673</td>
<td>1.098612</td>
<td>6.634896</td>
<td>1.733545</td>
<td>424</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="preprocess-audit-compact-decision-useful" class="level3" data-number="4.8">
<h3 data-number="4.8" class="anchored" data-anchor-id="preprocess-audit-compact-decision-useful"><span class="header-section-number">4.8</span> Preprocess audit (compact, decision-useful)</h3>
<div id="5ff7466e" class="cell" data-execution_count="38">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>preprocess_audit <span class="op">=</span> pd.DataFrame({</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_contacts"</span>: [<span class="bu">int</span>(X.shape[<span class="dv">0</span>])],</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_model_features"</span>: [<span class="bu">int</span>(X.shape[<span class="dv">1</span>])],</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_constant_dropped"</span>: [<span class="bu">int</span>(<span class="bu">len</span>(constant_cols))],</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"constant_dropped"</span>: [<span class="st">", "</span>.join(constant_cols) <span class="cf">if</span> constant_cols <span class="cf">else</span> <span class="st">"None"</span>],</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"clip_low_quantile"</span>: [CLIP_LO],</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"clip_high_quantile"</span>: [CLIP_HI],</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_features_with_missing_before"</span>: [<span class="bu">int</span>((X_raw.isna().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">sum</span>())],</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_missing_cells_before"</span>: [<span class="bu">int</span>(X_raw.isna().<span class="bu">sum</span>().<span class="bu">sum</span>())],</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_abs_after_scaling"</span>: [<span class="bu">float</span>(np.<span class="bu">max</span>(np.<span class="bu">abs</span>(X)))],</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>preprocess_audit</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="107">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_contacts</th>
<th data-quarto-table-cell-role="th">n_model_features</th>
<th data-quarto-table-cell-role="th">n_constant_dropped</th>
<th data-quarto-table-cell-role="th">constant_dropped</th>
<th data-quarto-table-cell-role="th">clip_low_quantile</th>
<th data-quarto-table-cell-role="th">clip_high_quantile</th>
<th data-quarto-table-cell-role="th">n_features_with_missing_before</th>
<th data-quarto-table-cell-role="th">total_missing_cells_before</th>
<th data-quarto-table-cell-role="th">max_abs_after_scaling</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2091</td>
<td>20</td>
<td>0</td>
<td>None</td>
<td>0.01</td>
<td>0.99</td>
<td>0</td>
<td>0</td>
<td>95.1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="store-preprocessing-artifacts-in-memory-safe-by-default" class="level3" data-number="4.9">
<h3 data-number="4.9" class="anchored" data-anchor-id="store-preprocessing-artifacts-in-memory-safe-by-default"><span class="header-section-number">4.9</span> Store preprocessing artifacts (in-memory, safe by default)</h3>
<div id="7cab6330" class="cell" data-execution_count="39">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>prep <span class="op">=</span> {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MODEL_FEATURES"</span>: MODEL_FEATURES,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FEATURE_BLOCKS"</span>: FEATURE_BLOCKS,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"feature_names"</span>: feature_names,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"imputer"</span>: imputer,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"scaler"</span>: scaler,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"X_raw"</span>: X_raw2,      <span class="co"># before clipping (audit)</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"X_clip"</span>: X_clip,     <span class="co"># clipped raw matrix (audit)</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"X"</span>: X,               <span class="co"># final clustering matrix</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"clip_table"</span>: clip_table,</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dominance"</span>: dominance,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"preprocess_audit"</span>: preprocess_audit</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Raw-unit summary (post-clip = what the scaler actually sees)</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>raw_summary <span class="op">=</span> X_clip.describe(percentiles<span class="op">=</span>[<span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="fl">0.95</span>, <span class="fl">0.99</span>]).T</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>raw_summary <span class="op">=</span> raw_summary[[<span class="st">"count"</span>, <span class="st">"mean"</span>, <span class="st">"std"</span>, <span class="st">"min"</span>, <span class="st">"50%"</span>, <span class="st">"90%"</span>, <span class="st">"95%"</span>, <span class="st">"99%"</span>, <span class="st">"max"</span>]]</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>raw_summary.head(<span class="dv">12</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="108">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">90%</th>
<th data-quarto-table-cell-role="th">95%</th>
<th data-quarto-table-cell-role="th">99%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">n_calls</th>
<td>2091.0</td>
<td>7.560641</td>
<td>22.535264</td>
<td>1.000000</td>
<td>2.000000</td>
<td>12.000000</td>
<td>28.000000</td>
<td>169.330000</td>
<td>172.300000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">n_days_active</th>
<td>2091.0</td>
<td>4.503156</td>
<td>12.474802</td>
<td>1.000000</td>
<td>1.000000</td>
<td>7.000000</td>
<td>17.000000</td>
<td>96.010000</td>
<td>96.100000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">calls_per_active_day</th>
<td>2091.0</td>
<td>1.490754</td>
<td>0.784284</td>
<td>1.000000</td>
<td>1.000000</td>
<td>2.333333</td>
<td>3.000000</td>
<td>5.000000</td>
<td>5.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">calls_per_tenure_day</th>
<td>2091.0</td>
<td>0.987043</td>
<td>0.853444</td>
<td>0.005871</td>
<td>1.000000</td>
<td>1.998381</td>
<td>2.894101</td>
<td>4.005407</td>
<td>4.028542</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">log_n_calls</th>
<td>2091.0</td>
<td>1.337442</td>
<td>0.932739</td>
<td>0.693147</td>
<td>1.098612</td>
<td>2.564949</td>
<td>3.367296</td>
<td>5.137573</td>
<td>5.153539</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">total_dur_sec</th>
<td>2091.0</td>
<td>711.445720</td>
<td>2477.954937</td>
<td>2.000000</td>
<td>91.000000</td>
<td>1107.000000</td>
<td>3019.500000</td>
<td>18608.600000</td>
<td>18830.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mean_dur_sec</th>
<td>2091.0</td>
<td>84.096441</td>
<td>126.033557</td>
<td>2.000000</td>
<td>45.000000</td>
<td>184.000000</td>
<td>310.800000</td>
<td>767.490000</td>
<td>771.900000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">median_dur_sec</th>
<td>2091.0</td>
<td>72.592396</td>
<td>115.864389</td>
<td>2.000000</td>
<td>38.500000</td>
<td>153.500000</td>
<td>276.500000</td>
<td>760.020000</td>
<td>760.200000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">p90_dur_sec</th>
<td>2091.0</td>
<td>126.747585</td>
<td>215.263200</td>
<td>2.000000</td>
<td>62.000000</td>
<td>268.600000</td>
<td>494.400000</td>
<td>1375.010000</td>
<td>1375.100000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">log_total_dur</th>
<td>2091.0</td>
<td>4.617053</td>
<td>1.825819</td>
<td>1.098612</td>
<td>4.521789</td>
<td>7.010312</td>
<td>8.013169</td>
<td>9.831353</td>
<td>9.842541</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">log_median_dur</th>
<td>2091.0</td>
<td>3.546764</td>
<td>1.254063</td>
<td>1.098612</td>
<td>3.676301</td>
<td>5.040194</td>
<td>5.625780</td>
<td>6.634660</td>
<td>6.634896</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">long_call_share</th>
<td>2091.0</td>
<td>0.038448</td>
<td>0.156275</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.008288</td>
<td>0.285714</td>
<td>1.000000</td>
<td>1.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="a-final-numeric-stability-guardrail" class="level3" data-number="4.10">
<h3 data-number="4.10" class="anchored" data-anchor-id="a-final-numeric-stability-guardrail"><span class="header-section-number">4.10</span> A Final numeric stability guardrail</h3>
<p>Even after robust scaling, distance-based clustering can still be dominated by a small number of extreme points.<br>
To make the pipeline <strong>bullet-proof</strong>, we apply a final cap in standardized space so no single feature can overwhelm Euclidean distances.</p>
<div id="14330246" class="cell" data-execution_count="40">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Final stability cap in scaled space (portfolio-grade guardrail)</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>SCALED_CAP <span class="op">=</span> <span class="fl">10.0</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>X_uncapped <span class="op">=</span> prep[<span class="st">"X"</span>]</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>X_capped <span class="op">=</span> np.clip(X_uncapped, <span class="op">-</span>SCALED_CAP, SCALED_CAP)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>cap_audit <span class="op">=</span> pd.DataFrame({</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"scaled_cap"</span>: [SCALED_CAP],</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_abs_before"</span>: [<span class="bu">float</span>(np.<span class="bu">max</span>(np.<span class="bu">abs</span>(X_uncapped)))],</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_abs_after"</span>: [<span class="bu">float</span>(np.<span class="bu">max</span>(np.<span class="bu">abs</span>(X_capped)))],</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Update the matrix used downstream (keep uncapped for audit)</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"X_uncapped"</span>] <span class="op">=</span> X_uncapped</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"X"</span>] <span class="op">=</span> X_capped</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>cap_audit</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="109">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">scaled_cap</th>
<th data-quarto-table-cell-role="th">max_abs_before</th>
<th data-quarto-table-cell-role="th">max_abs_after</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>10.0</td>
<td>95.1</td>
<td>10.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Phase 3 — Sign-off (ready for K-selection)
</div>
</div>
<div class="callout-body-container callout-body">
<p>We produced a stable clustering matrix <code>prep["X"]</code> for <strong>2,091 contacts × 20 features</strong>.</p>
<p><strong>Robustness guarantees:</strong> - No missing values or infinities - Heavy tails controlled by <strong>p01–p99 clipping</strong> - Distance stability guaranteed by <strong>post-scaling cap</strong> (max absolute value ≤ 10)</p>
<p><strong>Next:</strong> Phase 4 chooses the number of clusters <span class="math inline">\(K\)</span> using a multi-metric selection protocol (inertia, silhouette, Davies–Bouldin) on <code>prep["X"]</code>.</p>
</div>
</div>
</section>
</section>
<section id="phase-4-choose-k-model-selection-for-clustering" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="phase-4-choose-k-model-selection-for-clustering"><span class="header-section-number">5</span> Phase 4 — Choose <span class="math inline">\(K\)</span> (model selection for clustering)</h2>
<p>Choosing <span class="math inline">\(K\)</span> is a <strong>model selection</strong> problem: different values of <span class="math inline">\(K\)</span> define different segmentations. We evaluate candidate <span class="math inline">\(K\)</span> values using three complementary criteria:</p>
<ul>
<li><strong>Inertia (SSE)</strong>: decreases with <span class="math inline">\(K\)</span>; we look for an “elbow” (diminishing returns).</li>
<li><strong>Silhouette</strong>: higher is better; measures separation vs cohesion.</li>
<li><strong>Davies–Bouldin</strong>: lower is better; penalizes overlapping clusters.</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>We compute metrics on the <strong>preprocessed matrix</strong> <code>prep["X"]</code> (robust-scaled and capped).<br>
This ensures the <span class="math inline">\(K\)</span> decision reflects behavioural structure rather than raw-unit dominance.</p>
</div>
</div>
<hr>
<section id="compute-k-search-metrics" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="compute-k-search-metrics"><span class="header-section-number">5.1</span> Compute <span class="math inline">\(K\)</span>-search metrics</h3>
<div id="8a36705b" class="cell" data-execution_count="41">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> silhouette_score, davies_bouldin_score</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> prep[<span class="st">"X"</span>]  <span class="co"># capped, clustering-ready matrix</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Candidate K range (employer-ready default)</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>K_MIN, K_MAX <span class="op">=</span> <span class="dv">2</span>, <span class="dv">12</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> []</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(K_MIN, K_MAX <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    km <span class="op">=</span> KMeans(</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>        n_clusters<span class="op">=</span>k,</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>        n_init<span class="op">=</span><span class="dv">50</span>,         <span class="co"># more restarts = more reliable</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> km.fit_predict(X)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    inertia <span class="op">=</span> <span class="bu">float</span>(km.inertia_)</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    sil <span class="op">=</span> <span class="bu">float</span>(silhouette_score(X, labels))</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>    db <span class="op">=</span> <span class="bu">float</span>(davies_bouldin_score(X, labels))</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    rows.append({</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"k"</span>: k,</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"inertia"</span>: inertia,</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"silhouette"</span>: sil,</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"davies_bouldin"</span>: db</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>k_metrics <span class="op">=</span> pd.DataFrame(rows)</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a simple "elbow help": marginal gain in inertia</span></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>k_metrics[<span class="st">"inertia_drop"</span>] <span class="op">=</span> k_metrics[<span class="st">"inertia"</span>].shift(<span class="dv">1</span>) <span class="op">-</span> k_metrics[<span class="st">"inertia"</span>]</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>k_metrics[<span class="st">"inertia_drop_pct"</span>] <span class="op">=</span> (k_metrics[<span class="st">"inertia_drop"</span>] <span class="op">/</span> k_metrics[<span class="st">"inertia"</span>].shift(<span class="dv">1</span>)) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>k_metrics</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="110">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">k</th>
<th data-quarto-table-cell-role="th">inertia</th>
<th data-quarto-table-cell-role="th">silhouette</th>
<th data-quarto-table-cell-role="th">davies_bouldin</th>
<th data-quarto-table-cell-role="th">inertia_drop</th>
<th data-quarto-table-cell-role="th">inertia_drop_pct</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2</td>
<td>50974.583857</td>
<td>0.651267</td>
<td>0.746627</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>3</td>
<td>37194.004774</td>
<td>0.646105</td>
<td>0.828924</td>
<td>13780.579083</td>
<td>27.034216</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>4</td>
<td>26086.981574</td>
<td>0.589088</td>
<td>0.771859</td>
<td>11107.023200</td>
<td>29.862402</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>5</td>
<td>22856.984343</td>
<td>0.482657</td>
<td>0.926567</td>
<td>3229.997231</td>
<td>12.381644</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>6</td>
<td>20323.525176</td>
<td>0.457261</td>
<td>0.999610</td>
<td>2533.459166</td>
<td>11.083961</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>7</td>
<td>18523.891058</td>
<td>0.430309</td>
<td>1.050928</td>
<td>1799.634118</td>
<td>8.854931</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>8</td>
<td>16933.390393</td>
<td>0.396590</td>
<td>1.021011</td>
<td>1590.500665</td>
<td>8.586213</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>9</td>
<td>15403.105156</td>
<td>0.375016</td>
<td>1.019315</td>
<td>1530.285237</td>
<td>9.037087</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>10</td>
<td>14055.290862</td>
<td>0.320327</td>
<td>0.997488</td>
<td>1347.814294</td>
<td>8.750277</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>11</td>
<td>13118.789180</td>
<td>0.319340</td>
<td>1.022192</td>
<td>936.501682</td>
<td>6.662983</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>12</td>
<td>12285.369653</td>
<td>0.321039</td>
<td>1.040977</td>
<td>833.419528</td>
<td>6.352869</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="visualize-metrics-elbow-quality-trade-offs" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="visualize-metrics-elbow-quality-trade-offs"><span class="header-section-number">5.2</span> Visualize metrics (elbow + quality trade-offs)</h3>
<div id="8f029a69" class="cell" data-execution_count="42">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="walsoft_contact_segmentation_files/figure-html/cell-43-output-1.png" width="662" height="470" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="walsoft_contact_segmentation_files/figure-html/cell-43-output-2.png" width="662" height="470" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="walsoft_contact_segmentation_files/figure-html/cell-43-output-3.png" width="662" height="470" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="candidate-shortlist-data-driven" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="candidate-shortlist-data-driven"><span class="header-section-number">5.3</span> Candidate shortlist (data-driven)</h3>
<p>We shortlist <span class="math inline">\(K\)</span> values that are plausible trade-offs:</p>
<ul>
<li>among the <strong>top silhouette</strong> scores,</li>
<li>among the <strong>lowest Davies–Bouldin</strong> scores,</li>
<li>and not far beyond the elbow (where inertia gains flatten).</li>
</ul>
<div id="e51e64af" class="cell" data-execution_count="43">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Candidate shortlist — modern, auditable</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify top-K by each metric</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>top_sil <span class="op">=</span> k_metrics.nlargest(<span class="dv">5</span>, <span class="st">"silhouette"</span>).copy()</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>top_sil[<span class="st">"reason"</span>] <span class="op">=</span> <span class="st">"top_silhouette"</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>low_db <span class="op">=</span> k_metrics.nsmallest(<span class="dv">5</span>, <span class="st">"davies_bouldin"</span>).copy()</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>low_db[<span class="st">"reason"</span>] <span class="op">=</span> <span class="st">"low_davies_bouldin"</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine and mark duplicates</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>shortlist <span class="op">=</span> pd.concat([top_sil, low_db]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="co"># If a K appears in both, update reason</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>shortlist <span class="op">=</span> (</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    shortlist.groupby(<span class="st">"k"</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    .agg({</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"silhouette"</span>: <span class="st">"first"</span>,</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"davies_bouldin"</span>: <span class="st">"first"</span>,</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"inertia"</span>: <span class="st">"first"</span>,</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"reason"</span>: <span class="kw">lambda</span> x: <span class="st">" &amp; "</span>.join(<span class="bu">sorted</span>(<span class="bu">set</span>(x)))</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"k"</span>)</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Round metrics for readability</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>shortlist[[<span class="st">"silhouette"</span>, <span class="st">"davies_bouldin"</span>, <span class="st">"inertia"</span>]] <span class="op">=</span> shortlist[</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"silhouette"</span>, <span class="st">"davies_bouldin"</span>, <span class="st">"inertia"</span>]</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>].<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>shortlist</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="112">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">k</th>
<th data-quarto-table-cell-role="th">silhouette</th>
<th data-quarto-table-cell-role="th">davies_bouldin</th>
<th data-quarto-table-cell-role="th">inertia</th>
<th data-quarto-table-cell-role="th">reason</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2</td>
<td>0.6513</td>
<td>0.7466</td>
<td>50974.5839</td>
<td>low_davies_bouldin &amp; top_silhouette</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>3</td>
<td>0.6461</td>
<td>0.8289</td>
<td>37194.0048</td>
<td>low_davies_bouldin &amp; top_silhouette</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>4</td>
<td>0.5891</td>
<td>0.7719</td>
<td>26086.9816</td>
<td>low_davies_bouldin &amp; top_silhouette</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>5</td>
<td>0.4827</td>
<td>0.9266</td>
<td>22856.9843</td>
<td>low_davies_bouldin &amp; top_silhouette</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>6</td>
<td>0.4573</td>
<td>0.9996</td>
<td>20323.5252</td>
<td>top_silhouette</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>10</td>
<td>0.3203</td>
<td>0.9975</td>
<td>14055.2909</td>
<td>low_davies_bouldin</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="what-the-metrics-say-from-first-principles" class="level3" data-number="5.4">
<h3 data-number="5.4" class="anchored" data-anchor-id="what-the-metrics-say-from-first-principles"><span class="header-section-number">5.4</span> What the metrics say (from first principles)</h3>
<section id="inertia-elbow" class="level4" data-number="5.4.1">
<h4 data-number="5.4.1" class="anchored" data-anchor-id="inertia-elbow"><span class="header-section-number">5.4.1</span> Inertia (elbow)</h4>
<p>Huge drops from <strong>K=2 → 3</strong> (~27%) and <strong>3 → 4</strong> (~30%).<br>
After <strong>K=4</strong>, the drop collapses to ~12% and then &lt;~11% thereafter.<br>
That’s a classic <strong>elbow at K≈4</strong>.</p>
</section>
<section id="silhouette-separation-vs-cohesion" class="level4" data-number="5.4.2">
<h4 data-number="5.4.2" class="anchored" data-anchor-id="silhouette-separation-vs-cohesion"><span class="header-section-number">5.4.2</span> Silhouette (separation vs cohesion)</h4>
<ul>
<li><strong>K=2:</strong> 0.651 (very strong)<br>
</li>
<li><strong>K=3:</strong> 0.646 (very strong)<br>
</li>
<li><strong>K=4:</strong> 0.589 (still strong)</li>
</ul>
<p>Then it falls sharply (e.g., <strong>K=5</strong> = 0.483 and continues down).<br>
Structure is strongest for small K, especially <strong>2–4</strong>.</p>
</section>
<section id="daviesbouldin-overlap-lower-is-better" class="level4" data-number="5.4.3">
<h4 data-number="5.4.3" class="anchored" data-anchor-id="daviesbouldin-overlap-lower-is-better"><span class="header-section-number">5.4.3</span> Davies–Bouldin (overlap; lower is better)</h4>
<ul>
<li>Best is <strong>K=2</strong> (0.747), then <strong>K=4</strong> (0.772), then <strong>K=3</strong> (0.829).<br>
After that, the metric worsens notably.</li>
</ul>
<hr>
</section>
</section>
<section id="decision" class="level3" data-number="5.5">
<h3 data-number="5.5" class="anchored" data-anchor-id="decision"><span class="header-section-number">5.5</span> Decision</h3>
<p>Choose <strong>K=4</strong> (recommended).</p>
<ul>
<li><strong>K=2:</strong> too coarse for actionability (“low vs high activity”)<br>
</li>
<li><strong>K=3:</strong> better but still merges distinct behaviours (“steady frequent” vs “bursty intense”)<br>
</li>
<li><strong>K=4:</strong> lands at the elbow, with strong silhouette &amp; Davies–Bouldin — best balance of interpretability, actionability, and metric support.</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Decision: choose <span class="math inline">\(K=4\)</span>
</div>
</div>
<div class="callout-body-container callout-body">
<p>We select <strong><span class="math inline">\(K=4\)</span></strong> as the operational segmentation because it balances:</p>
<ul>
<li><strong>Structure quality:</strong> strong silhouette (0.589) and low Davies–Bouldin (0.772)<br>
</li>
<li><strong>Parsimony:</strong> clear elbow around <strong>K=4</strong> (large inertia drops up to 4, then diminishing returns)<br>
</li>
<li><strong>Actionability:</strong> more useful than K=2 while avoiding over-fragmentation at higher K</li>
</ul>
<p><strong>Next:</strong> fit K-means with <strong>K=4</strong> and interpret clusters using feature-block summaries (volume, duration, recency, timing).</p>
</div>
</div>
<hr>
</section>
<section id="optional-why-we-may-explore-k5-exploratory-only" class="level3" data-number="5.6">
<h3 data-number="5.6" class="anchored" data-anchor-id="optional-why-we-may-explore-k5-exploratory-only"><span class="header-section-number">5.6</span> Optional: why we may explore <span class="math inline">\(K=5\)</span> (exploratory only)</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math inline">\(K=5\)</span> is <strong>not</strong> recommended as the default operational segmentation in this project.</p>
<p>Compared to <span class="math inline">\(K=4\)</span>, separation quality declines noticeably:</p>
<ul>
<li>Silhouette: <strong>0.589 → 0.483</strong> (weaker cohesion/separation)</li>
<li>Davies–Bouldin: <strong>0.772 → 0.927</strong> (more overlap between clusters)</li>
</ul>
<p>We may still explore <span class="math inline">\(K=5\)</span> <strong>only as an exploratory lens</strong> when stakeholders want finer distinctions inside high-activity groups (e.g., separating “steady frequent” from “burst-intense”). Any <span class="math inline">\(K=5\)</span> results should be presented as <em>additional insight</em> without changing the primary framework.</p>
</div>
</div>
<blockquote class="blockquote">
<p><strong>Stakeholder takeaway:</strong> K=4 remains the primary segmentation. K=5 can be used <strong>selectively</strong> to provide additional insights where fine distinctions are important, without altering the main operational framework.</p>
</blockquote>
<hr>
</section>
</section>
<section id="phase-5-fit-and-interpret-clusters-k-means-k4" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="phase-5-fit-and-interpret-clusters-k-means-k4"><span class="header-section-number">6</span> Phase 5 — Fit and interpret clusters (K-means, <span class="math inline">\(K=4\)</span>)</h2>
<p>We fit K-means on the <strong>clustering matrix</strong> <code>prep["X"]</code> (robust-scaled and capped for numeric stability).<br>
For interpretation, we summarise clusters back in <strong>business units</strong> using <code>contact_features_view</code> (raw-unit features) and translate clusters into <strong>stakeholder-ready segments with actions</strong>.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Training vs interpretation (do not mix these)
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Training:</strong> uses <code>prep["X"]</code> (scaled + capped) so Euclidean distances are fair and stable.</li>
<li><strong>Interpretation:</strong> uses raw-unit features (calls, seconds, days, shares) so segments can be explained and acted on.</li>
<li><strong>Privacy:</strong> we keep <code>contact_id</code> hashed and do not merge any name/number fields into report outputs.</li>
</ul>
</div>
</div>
<hr>
<section id="fit-k-means-k4-and-store-labels" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="fit-k-means-k4-and-store-labels"><span class="header-section-number">6.1</span> Fit K-means (<span class="math inline">\(K=4\)</span>) and store labels</h3>
<div id="0eb5d220" class="cell" data-execution_count="44">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> prep[<span class="st">"X"</span>]   <span class="co"># final clustering matrix (scaled + capped)</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>K_FINAL <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>kmeans <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>K_FINAL, n_init<span class="op">=</span><span class="dv">50</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> kmeans.fit_predict(X)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co"># One label per contact (hashed ID only)</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>contact_clusters <span class="op">=</span> pd.DataFrame({</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"contact_id"</span>: contact_features_view[<span class="st">"contact_id"</span>].values,</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cluster"</span>: labels</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>cluster_sizes <span class="op">=</span> (</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    contact_clusters[<span class="st">"cluster"</span>]</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    .value_counts()</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    .sort_index()</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>    .to_frame(<span class="st">"n_contacts"</span>)</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>cluster_sizes</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="113">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_contacts</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">cluster</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>91</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>176</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>1599</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>225</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="join-clusters-back-to-contact-level-table-raw-units" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="join-clusters-back-to-contact-level-table-raw-units"><span class="header-section-number">6.2</span> Join clusters back to contact-level table (raw units)</h3>
<div id="5cbdf9f3" class="cell" data-execution_count="45">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>contact_labeled <span class="op">=</span> contact_features_view.merge(contact_clusters, on<span class="op">=</span><span class="st">"contact_id"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Hard gate: every contact must get a cluster label</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> contact_labeled[<span class="st">"cluster"</span>].isna().<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>contact_labeled[[<span class="st">"contact_id"</span>, <span class="st">"cluster"</span>]].head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="114">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">contact_id</th>
<th data-quarto-table-cell-role="th">cluster</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>00047e187745</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>000d71073f3e</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>001c36642ecb</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>00ad9a0b1291</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>00ed0d18f9e3</td>
<td>2</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="cluster-cards-robust-medians-size" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="cluster-cards-robust-medians-size"><span class="header-section-number">6.3</span> Cluster “cards” (robust medians + size)</h3>
<p>These cards are stakeholder-ready: <strong>one row per cluster</strong>, using <strong>medians</strong> (robust to heavy tails).</p>
<div id="1b0a82ed" class="cell" data-execution_count="46">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>card_features <span class="op">=</span> [</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># volume / intensity</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_calls"</span>, <span class="st">"n_days_active"</span>, <span class="st">"calls_per_active_day"</span>,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># duration / relationship depth proxy</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_dur_sec"</span>, <span class="st">"median_dur_sec"</span>, <span class="st">"long_call_share"</span>,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># recency / tenure</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"recency_days"</span>, <span class="st">"tenure_days"</span>,</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># timing mix</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"share_business_hours"</span>, <span class="st">"share_evening"</span>, <span class="st">"share_early_morning"</span>, <span class="st">"share_late_night"</span>,</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"share_open_day"</span>, <span class="st">"share_closed_day"</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>missing_cards <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> card_features <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> contact_labeled.columns]</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(missing_cards) <span class="op">==</span> <span class="dv">0</span>, <span class="ss">f"Missing card features: </span><span class="sc">{</span>missing_cards<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>cards <span class="op">=</span> (</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    contact_labeled</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"cluster"</span>)[card_features]</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    .median()</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    .merge(cluster_sizes, left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>cards <span class="op">=</span> cards[[<span class="st">"cluster"</span>, <span class="st">"n_contacts"</span>] <span class="op">+</span> card_features]</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>cards.T</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="115">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">cluster</th>
<td>0.000000</td>
<td>1.000000</td>
<td>2.000000</td>
<td>3.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">n_contacts</th>
<td>91.000000</td>
<td>176.000000</td>
<td>1599.000000</td>
<td>225.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">n_calls</th>
<td>2.000000</td>
<td>35.500000</td>
<td>1.000000</td>
<td>5.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">n_days_active</th>
<td>2.000000</td>
<td>21.000000</td>
<td>1.000000</td>
<td>4.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">calls_per_active_day</th>
<td>1.200000</td>
<td>1.707143</td>
<td>1.000000</td>
<td>1.333333</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">total_dur_sec</th>
<td>1553.000000</td>
<td>2776.000000</td>
<td>61.000000</td>
<td>270.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">median_dur_sec</th>
<td>494.000000</td>
<td>35.500000</td>
<td>37.000000</td>
<td>34.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">long_call_share</th>
<td>0.600000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">recency_days</th>
<td>621.220833</td>
<td>84.802164</td>
<td>501.331516</td>
<td>259.384988</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">tenure_days</th>
<td>0.813924</td>
<td>676.594664</td>
<td>0.000000</td>
<td>312.908426</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_business_hours</th>
<td>1.000000</td>
<td>0.911879</td>
<td>1.000000</td>
<td>1.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_evening</th>
<td>0.000000</td>
<td>0.047619</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_early_morning</th>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_late_night</th>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_open_day</th>
<td>1.000000</td>
<td>0.983416</td>
<td>1.000000</td>
<td>1.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_closed_day</th>
<td>0.000000</td>
<td>0.016584</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="within-cluster-spread-check-to-avoid-misleading-medians" class="level3" data-number="6.4">
<h3 data-number="6.4" class="anchored" data-anchor-id="within-cluster-spread-check-to-avoid-misleading-medians"><span class="header-section-number">6.4</span> Within-cluster spread check (to avoid misleading medians)</h3>
<p>We report 25/50/75% for a few “anchor” variables.</p>
<div id="38689f47" class="cell" data-execution_count="47">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>spread_features <span class="op">=</span> [<span class="st">"n_calls"</span>, <span class="st">"total_dur_sec"</span>, <span class="st">"recency_days"</span>, <span class="st">"median_dur_sec"</span>]</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>spread <span class="op">=</span> (</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    contact_labeled</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"cluster"</span>)[spread_features]</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    .quantile([<span class="fl">0.25</span>, <span class="fl">0.50</span>, <span class="fl">0.75</span>])</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    .unstack(level<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>spread.columns <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>feat<span class="sc">}</span><span class="ss">_q</span><span class="sc">{</span><span class="bu">int</span>(q<span class="op">*</span><span class="dv">100</span>)<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> feat, q <span class="kw">in</span> spread.columns]</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>spread <span class="op">=</span> spread.reset_index()</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>spread.T</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="116">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">cluster</th>
<td>0.000000</td>
<td>1.000000</td>
<td>2.000000</td>
<td>3.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">n_calls_q25</th>
<td>1.000000</td>
<td>23.000000</td>
<td>1.000000</td>
<td>3.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">n_calls_q50</th>
<td>2.000000</td>
<td>35.500000</td>
<td>1.000000</td>
<td>5.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">n_calls_q75</th>
<td>4.000000</td>
<td>85.250000</td>
<td>2.000000</td>
<td>9.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">total_dur_sec_q25</th>
<td>819.500000</td>
<td>1156.750000</td>
<td>22.000000</td>
<td>109.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">total_dur_sec_q50</th>
<td>1553.000000</td>
<td>2776.000000</td>
<td>61.000000</td>
<td>270.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">total_dur_sec_q75</th>
<td>2971.500000</td>
<td>8409.500000</td>
<td>134.000000</td>
<td>507.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">recency_days_q25</th>
<td>273.385498</td>
<td>59.149308</td>
<td>259.746244</td>
<td>94.075741</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">recency_days_q50</th>
<td>621.220833</td>
<td>84.802164</td>
<td>501.331516</td>
<td>259.384988</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">recency_days_q75</th>
<td>823.246152</td>
<td>255.288302</td>
<td>781.281389</td>
<td>515.196192</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">median_dur_sec_q25</th>
<td>355.000000</td>
<td>22.500000</td>
<td>11.000000</td>
<td>12.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">median_dur_sec_q50</th>
<td>494.000000</td>
<td>35.500000</td>
<td>37.000000</td>
<td>34.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">median_dur_sec_q75</th>
<td>748.500000</td>
<td>59.125000</td>
<td>72.500000</td>
<td>60.500000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Why timing-share medians often look like 0 or 1
</div>
</div>
<div class="callout-body-container callout-body">
<p>Many contacts have only 1–2 calls. With tiny denominators, share features become extreme. So for timing behaviour we also report <strong>means</strong> and <strong>% of contacts with any activity</strong> in each time band.</p>
</div>
</div>
<hr>
</section>
<section id="timing-patterns-mean-shares-with-any-non-business-hours-sunday-activity" class="level3" data-number="6.5">
<h3 data-number="6.5" class="anchored" data-anchor-id="timing-patterns-mean-shares-with-any-non-business-hours-sunday-activity"><span class="header-section-number">6.5</span> Timing patterns (mean shares + % with any non-business-hours / Sunday activity)</h3>
<div id="02b064bb" class="cell" data-execution_count="48">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>share_cols <span class="op">=</span> [</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"share_business_hours"</span>, <span class="st">"share_evening"</span>, <span class="st">"share_early_morning"</span>, <span class="st">"share_late_night"</span>,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"share_open_day"</span>, <span class="st">"share_closed_day"</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>timing_mean <span class="op">=</span> (</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    contact_labeled</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"cluster"</span>)[share_cols]</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    .add_suffix(<span class="st">"_mean"</span>)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>timing_any <span class="op">=</span> (</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    contact_labeled</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>        any_evening<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"share_evening"</span>] <span class="op">&gt;</span> <span class="dv">0</span>).astype(<span class="bu">int</span>),</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>        any_early_morning<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"share_early_morning"</span>] <span class="op">&gt;</span> <span class="dv">0</span>).astype(<span class="bu">int</span>),</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>        any_late_night<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"share_late_night"</span>] <span class="op">&gt;</span> <span class="dv">0</span>).astype(<span class="bu">int</span>),</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>        any_sunday<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"share_closed_day"</span>] <span class="op">&gt;</span> <span class="dv">0</span>).astype(<span class="bu">int</span>),</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"cluster"</span>)[[<span class="st">"any_evening"</span>, <span class="st">"any_early_morning"</span>, <span class="st">"any_late_night"</span>, <span class="st">"any_sunday"</span>]]</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    .mul(<span class="dv">100</span>)</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>    .add_suffix(<span class="st">"_pct_contacts"</span>)</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>timing_summary <span class="op">=</span> (</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>    timing_mean</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>    .merge(timing_any, on<span class="op">=</span><span class="st">"cluster"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>    .merge(cluster_sizes.reset_index(), on<span class="op">=</span><span class="st">"cluster"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"cluster"</span>)</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>timing_summary.T</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="117">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">cluster</th>
<td>0.000000</td>
<td>1.000000</td>
<td>2.000000</td>
<td>3.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_business_hours_mean</th>
<td>0.874036</td>
<td>0.837563</td>
<td>0.905810</td>
<td>0.874097</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_evening_mean</th>
<td>0.077054</td>
<td>0.108877</td>
<td>0.065602</td>
<td>0.094157</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_early_morning_mean</th>
<td>0.033106</td>
<td>0.040734</td>
<td>0.020386</td>
<td>0.022898</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_late_night_mean</th>
<td>0.015803</td>
<td>0.012827</td>
<td>0.008203</td>
<td>0.008848</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">share_open_day_mean</th>
<td>0.917799</td>
<td>0.935881</td>
<td>0.957316</td>
<td>0.950137</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">share_closed_day_mean</th>
<td>0.082201</td>
<td>0.064119</td>
<td>0.042684</td>
<td>0.049863</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">any_evening_pct_contacts</th>
<td>15.384615</td>
<td>67.045455</td>
<td>9.130707</td>
<td>31.555556</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">any_early_morning_pct_contacts</th>
<td>8.791209</td>
<td>48.295455</td>
<td>3.189493</td>
<td>12.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">any_late_night_pct_contacts</th>
<td>5.494505</td>
<td>25.568182</td>
<td>1.438399</td>
<td>3.111111</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">any_sunday_pct_contacts</th>
<td>15.384615</td>
<td>54.545455</td>
<td>5.753596</td>
<td>19.111111</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">n_contacts</th>
<td>91.000000</td>
<td>176.000000</td>
<td>1599.000000</td>
<td>225.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="segment-names-action-policy-stakeholder-ready-layer" class="level3" data-number="6.6">
<h3 data-number="6.6" class="anchored" data-anchor-id="segment-names-action-policy-stakeholder-ready-layer"><span class="header-section-number">6.6</span> Segment names + action policy (stakeholder-ready layer)</h3>
<p>Cluster IDs are arbitrary. We map clusters to segment labels using <strong>behavioural signatures</strong> from <code>cards</code>.</p>
<div id="044ff743" class="cell" data-execution_count="49">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>sig <span class="op">=</span> cards[[</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cluster"</span>, <span class="st">"n_contacts"</span>,</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_calls"</span>, <span class="st">"total_dur_sec"</span>, <span class="st">"median_dur_sec"</span>, <span class="st">"long_call_share"</span>,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"recency_days"</span>, <span class="st">"tenure_days"</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>]].copy()</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify clusters by signatures (robust against label permutation)</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>one_off_cluster <span class="op">=</span> <span class="bu">int</span>(sig.sort_values([<span class="st">"n_calls"</span>, <span class="st">"total_dur_sec"</span>], ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">True</span>]).iloc[<span class="dv">0</span>][<span class="st">"cluster"</span>])</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>core_active_cluster <span class="op">=</span> <span class="bu">int</span>(sig.sort_values([<span class="st">"n_calls"</span>, <span class="st">"n_contacts"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>]).iloc[<span class="dv">0</span>][<span class="st">"cluster"</span>])</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>rare_deep_cluster <span class="op">=</span> <span class="bu">int</span>(sig.sort_values([<span class="st">"median_dur_sec"</span>, <span class="st">"long_call_share"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>]).iloc[<span class="dv">0</span>][<span class="st">"cluster"</span>])</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>remaining <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">set</span>(sig[<span class="st">"cluster"</span>]) <span class="op">-</span> {one_off_cluster, core_active_cluster, rare_deep_cluster})</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(remaining) <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Expected exactly one remaining cluster for 'warm occasional'."</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>warm_cluster <span class="op">=</span> <span class="bu">int</span>(remaining[<span class="dv">0</span>])</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>segment_map <span class="op">=</span> {</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    one_off_cluster: {</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"label"</span>: <span class="st">"One-off / low-engagement contacts"</span>,</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"primary_action"</span>: <span class="st">"Deprioritize by default; automate nurture; reactivate only if new activity appears"</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    core_active_cluster: {</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"label"</span>: <span class="st">"Core active relationships"</span>,</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"primary_action"</span>: <span class="st">"Retention + priority servicing; assign owner; proactive follow-ups"</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>    warm_cluster: {</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"label"</span>: <span class="st">"Warm occasional contacts"</span>,</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"primary_action"</span>: <span class="st">"Nurture cadence (monthly/quarterly); structured check-ins to increase engagement"</span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>    rare_deep_cluster: {</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"label"</span>: <span class="st">"Rare deep conversations"</span>,</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"primary_action"</span>: <span class="st">"High-touch when active; preserve context; personalized re-engagement when dormant"</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>cluster_labels <span class="op">=</span> (</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame([</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"cluster"</span>: k, <span class="st">"segment_label"</span>: v[<span class="st">"label"</span>], <span class="st">"primary_action"</span>: v[<span class="st">"primary_action"</span>]}</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k, v <span class="kw">in</span> segment_map.items()</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>    .merge(cluster_sizes.reset_index(), on<span class="op">=</span><span class="st">"cluster"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"cluster"</span>)</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>cluster_labels</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="118">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cluster</th>
<th data-quarto-table-cell-role="th">segment_label</th>
<th data-quarto-table-cell-role="th">primary_action</th>
<th data-quarto-table-cell-role="th">n_contacts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0</td>
<td>Rare deep conversations</td>
<td>High-touch when active; preserve context; pers...</td>
<td>91</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>1</td>
<td>Core active relationships</td>
<td>Retention + priority servicing; assign owner; ...</td>
<td>176</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2</td>
<td>One-off / low-engagement contacts</td>
<td>Deprioritize by default; automate nurture; rea...</td>
<td>1599</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>3</td>
<td>Warm occasional contacts</td>
<td>Nurture cadence (monthly/quarterly); structure...</td>
<td>225</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="cluster-narrative-auto-generated-from-the-cards" class="level3" data-number="6.7">
<h3 data-number="6.7" class="anchored" data-anchor-id="cluster-narrative-auto-generated-from-the-cards"><span class="header-section-number">6.7</span> Cluster narrative (auto-generated from the cards)</h3>
<p>Short and operational: “what it looks like” + “what to do”.</p>
<div id="73dc432e" class="cell" data-execution_count="50">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fmt(x, nd<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.isna(x):</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"NA"</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="bu">float</span>(x)<span class="sc">:.</span>{nd}f<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>cards_idx <span class="op">=</span> cards.set_index(<span class="st">"cluster"</span>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>labels_idx <span class="op">=</span> cluster_labels.set_index(<span class="st">"cluster"</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>narr_rows <span class="op">=</span> []</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> <span class="bu">sorted</span>(cards_idx.index):</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> cards_idx.loc[c]</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    seg <span class="op">=</span> labels_idx.loc[c, <span class="st">"segment_label"</span>]</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    act <span class="op">=</span> labels_idx.loc[c, <span class="st">"primary_action"</span>]</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    narrative <span class="op">=</span> (</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>seg<span class="sc">}</span><span class="ss">: median calls=</span><span class="sc">{</span>fmt(row[<span class="st">'n_calls'</span>],<span class="dv">1</span>)<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"median active days=</span><span class="sc">{</span>fmt(row[<span class="st">'n_days_active'</span>],<span class="dv">1</span>)<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"median total duration (sec)=</span><span class="sc">{</span>fmt(row[<span class="st">'total_dur_sec'</span>],<span class="dv">0</span>)<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"median call duration (sec)=</span><span class="sc">{</span>fmt(row[<span class="st">'median_dur_sec'</span>],<span class="dv">0</span>)<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"median recency (days)=</span><span class="sc">{</span>fmt(row[<span class="st">'recency_days'</span>],<span class="dv">0</span>)<span class="sc">}</span><span class="ss">."</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    narr_rows.append({</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cluster"</span>: <span class="bu">int</span>(c),</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"segment_label"</span>: seg,</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_contacts"</span>: <span class="bu">int</span>(row[<span class="st">"n_contacts"</span>]),</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cluster_story"</span>: narrative,</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"default_action"</span>: act</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>cluster_story <span class="op">=</span> pd.DataFrame(narr_rows).sort_values(<span class="st">"cluster"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>cluster_story</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="119">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cluster</th>
<th data-quarto-table-cell-role="th">segment_label</th>
<th data-quarto-table-cell-role="th">n_contacts</th>
<th data-quarto-table-cell-role="th">cluster_story</th>
<th data-quarto-table-cell-role="th">default_action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0</td>
<td>Rare deep conversations</td>
<td>91</td>
<td>Rare deep conversations: median calls=2.0, med...</td>
<td>High-touch when active; preserve context; pers...</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>1</td>
<td>Core active relationships</td>
<td>176</td>
<td>Core active relationships: median calls=35.5, ...</td>
<td>Retention + priority servicing; assign owner; ...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2</td>
<td>One-off / low-engagement contacts</td>
<td>1599</td>
<td>One-off / low-engagement contacts: median call...</td>
<td>Deprioritize by default; automate nurture; rea...</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>3</td>
<td>Warm occasional contacts</td>
<td>225</td>
<td>Warm occasional contacts: median calls=5.0, me...</td>
<td>Nurture cadence (monthly/quarterly); structure...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="what-decisions-can-the-business-make-with-these-segments" class="level3" data-number="6.8">
<h3 data-number="6.8" class="anchored" data-anchor-id="what-decisions-can-the-business-make-with-these-segments"><span class="header-section-number">6.8</span> “What decisions can the business make with these segments?”</h3>
<p>Policy rules we can implement in a CRM without exposing identifiers.</p>
<div id="6682be0b" class="cell" data-execution_count="51">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>rules <span class="op">=</span> pd.DataFrame([</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"segment_label"</span>: <span class="st">"Core active relationships"</span>,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"decision_use"</span>: <span class="st">"Prioritization and retention"</span>,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"operational_rule"</span>: <span class="st">"Assign owner and SLA; proactive check-ins"</span>,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"typical_pattern"</span>: <span class="st">"High calls, many active days, low recency"</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"segment_label"</span>: <span class="st">"Warm occasional contacts"</span>,</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"decision_use"</span>: <span class="st">"Nurture and growth"</span>,</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"operational_rule"</span>: <span class="st">"Monthly/quarterly outreach; reminders; targeted offers"</span>,</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"typical_pattern"</span>: <span class="st">"Moderate repeat calls, moderate tenure, mid recency"</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"segment_label"</span>: <span class="st">"Rare deep conversations"</span>,</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"decision_use"</span>: <span class="st">"High-touch exceptions and win-back"</span>,</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"operational_rule"</span>: <span class="st">"Personalized follow-up; preserve context; targeted reactivation if dormant"</span>,</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"typical_pattern"</span>: <span class="st">"Few calls but long conversations (high median duration / long-call share)"</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"segment_label"</span>: <span class="st">"One-off / low-engagement contacts"</span>,</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"decision_use"</span>: <span class="st">"Noise filtering and automation"</span>,</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"operational_rule"</span>: <span class="st">"Exclude from priority lists; automate nurture only"</span>,</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"typical_pattern"</span>: <span class="st">"One call, one day, small total duration, often old"</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>rules</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="120">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">segment_label</th>
<th data-quarto-table-cell-role="th">decision_use</th>
<th data-quarto-table-cell-role="th">operational_rule</th>
<th data-quarto-table-cell-role="th">typical_pattern</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Core active relationships</td>
<td>Prioritization and retention</td>
<td>Assign owner and SLA; proactive check-ins</td>
<td>High calls, many active days, low recency</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Warm occasional contacts</td>
<td>Nurture and growth</td>
<td>Monthly/quarterly outreach; reminders; targete...</td>
<td>Moderate repeat calls, moderate tenure, mid re...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Rare deep conversations</td>
<td>High-touch exceptions and win-back</td>
<td>Personalized follow-up; preserve context; targ...</td>
<td>Few calls but long conversations (high median ...</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>One-off / low-engagement contacts</td>
<td>Noise filtering and automation</td>
<td>Exclude from priority lists; automate nurture ...</td>
<td>One call, one day, small total duration, often...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="store-artifacts-for-later-phases-robustness-sensitivity-pca" class="level3" data-number="6.9">
<h3 data-number="6.9" class="anchored" data-anchor-id="store-artifacts-for-later-phases-robustness-sensitivity-pca"><span class="header-section-number">6.9</span> Store artifacts for later phases (robustness, sensitivity, PCA)</h3>
<div id="211e5595" class="cell" data-execution_count="52">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"K_FINAL"</span>] <span class="op">=</span> K_FINAL</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"kmeans"</span>] <span class="op">=</span> kmeans</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"labels"</span>] <span class="op">=</span> labels</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"contact_clusters"</span>] <span class="op">=</span> contact_clusters</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"cluster_sizes"</span>] <span class="op">=</span> cluster_sizes</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"cards"</span>] <span class="op">=</span> cards</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"spread"</span>] <span class="op">=</span> spread</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"timing_summary"</span>] <span class="op">=</span> timing_summary</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"cluster_labels"</span>] <span class="op">=</span> cluster_labels</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"cluster_story"</span>] <span class="op">=</span> cluster_story</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"rules"</span>] <span class="op">=</span> rules</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(prep.keys())[:<span class="dv">15</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="121">
<pre><code>['MODEL_FEATURES',
 'FEATURE_BLOCKS',
 'feature_names',
 'imputer',
 'scaler',
 'X_raw',
 'X_clip',
 'X',
 'clip_table',
 'dominance',
 'preprocess_audit',
 'X_uncapped',
 'K_FINAL',
 'kmeans',
 'labels']</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="phase-6-robustness-and-sensitivity-do-the-clusters-hold-up" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="phase-6-robustness-and-sensitivity-do-the-clusters-hold-up"><span class="header-section-number">7</span> Phase 6 — Robustness and sensitivity (do the clusters “hold up”?)</h2>
<p>A good clustering result is not just “a nice plot.” It should be <strong>stable</strong> when we rerun the algorithm and <strong>reasonably consistent</strong> when we change <em>feature blocks</em>.</p>
<p>In this phase we test two kinds of robustness:</p>
<ol type="1">
<li><strong>Seed stability:</strong> If we change the random seed (different K-means initializations), do we get essentially the same segmentation?</li>
<li><strong>Feature-block sensitivity:</strong> If we drop one block (volume, duration, recency, timing), do the segments remain broadly similar?</li>
</ol>
<p>We quantify stability using <strong>Adjusted Rand Index (ARI)</strong>:</p>
<ul>
<li><span class="math inline">\(ARI = 1\)</span> means two clusterings are identical up to label permutation.</li>
<li><span class="math inline">\(ARI \approx 0\)</span> means agreement is no better than random.</li>
<li>Negative <span class="math inline">\(ARI\)</span> can happen (worse than random agreement), usually a warning sign.</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Training matrix
</div>
</div>
<div class="callout-body-container callout-body">
<p>All robustness tests use <code>prep["X"]</code> (robust-scaled + capped) so distances are fair and numerically stable.</p>
<section id="privacy" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="privacy"><span class="header-section-number">7.1</span> Privacy</h3>
<p>We do not merge names/phone numbers into any robustness outputs. We only evaluate labels as arrays.</p>
</section>
</div>
</div>
<hr>
<section id="seed-stability-test-ari-across-many-random-seeds" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="seed-stability-test-ari-across-many-random-seeds"><span class="header-section-number">7.2</span> Seed stability test (ARI across many random seeds)</h3>
<p>We run K-means many times with different <code>random_state</code>, always using <span class="math inline">\(K = 4\)</span>, and compare each run to a baseline labeling.</p>
<div id="9e3472a2" class="cell" data-execution_count="53">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> adjusted_rand_score</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> prep[<span class="st">"X"</span>]</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>K_FINAL <span class="op">=</span> <span class="bu">int</span>(prep.get(<span class="st">"K_FINAL"</span>, <span class="dv">4</span>))</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Baseline labels (use Phase 5 if available)</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"labels"</span> <span class="kw">in</span> prep <span class="kw">and</span> prep.get(<span class="st">"labels"</span>, <span class="va">None</span>) <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    base_labels <span class="op">=</span> np.asarray(prep[<span class="st">"labels"</span>])</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    km0 <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>K_FINAL, n_init<span class="op">=</span><span class="dv">50</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    base_labels <span class="op">=</span> km0.fit_predict(X)</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Run many seeds</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>SEEDS <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">50</span>))  <span class="co"># employer-ready default</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> []</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> s <span class="kw">in</span> SEEDS:</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>    km <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>K_FINAL, n_init<span class="op">=</span><span class="dv">50</span>, random_state<span class="op">=</span>s)</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>    lab <span class="op">=</span> km.fit_predict(X)</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>    ari <span class="op">=</span> <span class="bu">float</span>(adjusted_rand_score(base_labels, lab))</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>    rows.append({<span class="st">"seed"</span>: s, <span class="st">"ari_vs_baseline"</span>: ari, <span class="st">"inertia"</span>: <span class="bu">float</span>(km.inertia_)})</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>seed_stability <span class="op">=</span> (</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame(rows)</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"ari_vs_baseline"</span>, ascending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>seed_audit <span class="op">=</span> pd.DataFrame({</span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"K_FINAL"</span>: [K_FINAL],</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_seeds_tested"</span>: [<span class="bu">len</span>(SEEDS)],</span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ari_min"</span>: [<span class="bu">float</span>(seed_stability[<span class="st">"ari_vs_baseline"</span>].<span class="bu">min</span>())],</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ari_p05"</span>: [<span class="bu">float</span>(seed_stability[<span class="st">"ari_vs_baseline"</span>].quantile(<span class="fl">0.05</span>))],</span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ari_median"</span>: [<span class="bu">float</span>(seed_stability[<span class="st">"ari_vs_baseline"</span>].median())],</span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ari_p95"</span>: [<span class="bu">float</span>(seed_stability[<span class="st">"ari_vs_baseline"</span>].quantile(<span class="fl">0.95</span>))],</span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ari_max"</span>: [<span class="bu">float</span>(seed_stability[<span class="st">"ari_vs_baseline"</span>].<span class="bu">max</span>())],</span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a>seed_audit, seed_stability.head(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="122">
<pre><code>(   K_FINAL  n_seeds_tested  ari_min  ari_p05  ari_median  ari_p95  ari_max
 0        4              50      1.0      1.0         1.0      1.0      1.0,
    seed  ari_vs_baseline       inertia
 0     0              1.0  26086.981574
 1     1              1.0  26086.981574
 2     2              1.0  26086.981574
 3     3              1.0  26086.981574
 4     4              1.0  26086.981574
 5     5              1.0  26086.981574
 6     6              1.0  26086.981574
 7     7              1.0  26086.981574
 8     8              1.0  26086.981574
 9     9              1.0  26086.981574)</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>How to interpret seed ARI
</div>
</div>
<div class="callout-body-container callout-body">
<p>A practical rule of thumb:</p>
<ul>
<li><strong>Very stable:</strong> most ARI values <span class="math inline">\(\ge 0.90\)</span></li>
<li><strong>Reasonably stable:</strong> most ARI values <span class="math inline">\(\ge 0.75\)</span></li>
<li><strong>Unstable:</strong> many ARI values <span class="math inline">\(&lt; 0.60\)</span></li>
</ul>
<p>If stability is weak, we usually revisit preprocessing, <span class="math inline">\(K\)</span>, or consider a different clustering method.</p>
</div>
</div>
<hr>
</section>
<section id="worst-case-rerun-inspection-label-aligned" class="level3" data-number="7.3">
<h3 data-number="7.3" class="anchored" data-anchor-id="worst-case-rerun-inspection-label-aligned"><span class="header-section-number">7.3</span> “Worst-case” rerun inspection (label-aligned)</h3>
<p>Even when ARI is <span class="math inline">\(1.0\)</span>, K-means can output the same partition with different numeric labels (label permutation). So we align labels before comparing cluster sizes.</p>
<div id="da046dd3" class="cell" data-execution_count="54">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify worst seed run (lowest ARI vs baseline)</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>worst <span class="op">=</span> seed_stability.iloc[<span class="dv">0</span>]</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>worst_seed <span class="op">=</span> <span class="bu">int</span>(worst[<span class="st">"seed"</span>])</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>km_worst <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>K_FINAL, n_init<span class="op">=</span><span class="dv">50</span>, random_state<span class="op">=</span>worst_seed)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>labels_worst <span class="op">=</span> km_worst.fit_predict(X)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>ari_worst <span class="op">=</span> <span class="bu">float</span>(adjusted_rand_score(base_labels, labels_worst))</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Contingency table: baseline cluster IDs (rows) vs worst run IDs (cols)</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> pd.crosstab(</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    pd.Series(base_labels, name<span class="op">=</span><span class="st">"baseline"</span>),</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    pd.Series(labels_worst, name<span class="op">=</span><span class="st">"worst"</span>)</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Map each worst-cluster to the baseline cluster it overlaps with most</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>mapping <span class="op">=</span> ct.idxmax(axis<span class="op">=</span><span class="dv">0</span>).to_dict()</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>labels_worst_aligned <span class="op">=</span> np.vectorize(mapping.get)(labels_worst)</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare cluster sizes after alignment</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>base_sizes <span class="op">=</span> pd.Series(base_labels).value_counts().sort_index()</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>worst_sizes <span class="op">=</span> pd.Series(labels_worst_aligned).value_counts().sort_index()</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>size_compare <span class="op">=</span> pd.DataFrame({</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cluster_id"</span>: <span class="bu">sorted</span>(<span class="bu">set</span>(base_sizes.index) <span class="op">|</span> <span class="bu">set</span>(worst_sizes.index)),</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>}).set_index(<span class="st">"cluster_id"</span>)</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>size_compare[<span class="st">"baseline_n"</span>] <span class="op">=</span> base_sizes.reindex(size_compare.index).fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>size_compare[<span class="st">"worst_n_aligned"</span>] <span class="op">=</span> worst_sizes.reindex(size_compare.index).fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>size_compare[<span class="st">"baseline_pct"</span>] <span class="op">=</span> (size_compare[<span class="st">"baseline_n"</span>] <span class="op">/</span> size_compare[<span class="st">"baseline_n"</span>].<span class="bu">sum</span>() <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>size_compare[<span class="st">"worst_pct_aligned"</span>] <span class="op">=</span> (size_compare[<span class="st">"worst_n_aligned"</span>] <span class="op">/</span> size_compare[<span class="st">"worst_n_aligned"</span>].<span class="bu">sum</span>() <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>worst_seed, <span class="bu">float</span>(worst[<span class="st">"ari_vs_baseline"</span>]), ari_worst, mapping, size_compare.reset_index()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="123">
<pre><code>(0,
 1.0,
 1.0,
 {0: 0, 1: 1, 2: 3, 3: 2},
    cluster_id  baseline_n  worst_n_aligned  baseline_pct  worst_pct_aligned
 0           0          91               91          4.35               4.35
 1           1         176              176          8.42               8.42
 2           2        1599             1599         76.47              76.47
 3           3         225              225         10.76              10.76)</code></pre>
</div>
</div>
<hr>
</section>
<section id="feature-block-sensitivity-drop-one-block-tests" class="level3" data-number="7.4">
<h3 data-number="7.4" class="anchored" data-anchor-id="feature-block-sensitivity-drop-one-block-tests"><span class="header-section-number">7.4</span> Feature-block sensitivity (drop-one-block tests)</h3>
<p>Now we test whether the segmentation depends too heavily on a single block. We refit K-means on reduced matrices and compare to baseline using ARI.</p>
<p>We do “drop one block at a time” on:</p>
<ul>
<li>volume</li>
<li>duration</li>
<li>recency</li>
<li>timing</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Why ARI is valid here
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cluster labels are arbitrary (cluster 0 in one run is not “the same” as cluster 0 in another). ARI is invariant to label permutation, so it compares structure, not label IDs.</p>
</div>
</div>
<div id="a5f30fb7" class="cell" data-execution_count="55">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> RobustScaler</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Rebuild X for each variant using the SAME preprocessing recipe as Phase 3:</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - drop constant cols</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - clip p01–p99 in raw space</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co"># - median impute + RobustScaler</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="co"># - cap in scaled space</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>SCALED_CAP <span class="op">=</span> <span class="bu">float</span>(prep.get(<span class="st">"scaled_cap"</span>, <span class="fl">10.0</span>))  <span class="co"># safe default</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>FEATURE_BLOCKS <span class="op">=</span> prep[<span class="st">"FEATURE_BLOCKS"</span>]</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>MODEL_FEATURES <span class="op">=</span> prep[<span class="st">"MODEL_FEATURES"</span>]</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>df_view <span class="op">=</span> contact_features_view  <span class="co"># raw-unit feature table</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_X_from_features(df, features, clip_lo<span class="op">=</span><span class="fl">0.01</span>, clip_hi<span class="op">=</span><span class="fl">0.99</span>, scaled_cap<span class="op">=</span><span class="fl">10.0</span>):</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    X_raw <span class="op">=</span> df[features].copy()</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop truly constant columns</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    nunique <span class="op">=</span> X_raw.nunique(dropna<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>    constant_cols <span class="op">=</span> nunique[nunique <span class="op">&lt;=</span> <span class="dv">1</span>].index.tolist()</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    X_raw2 <span class="op">=</span> X_raw.drop(columns<span class="op">=</span>constant_cols) <span class="cf">if</span> constant_cols <span class="cf">else</span> X_raw.copy()</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clip extremes in raw space</span></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>    X_clip <span class="op">=</span> X_raw2.copy()</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> X_clip.columns:</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>        lo <span class="op">=</span> <span class="bu">float</span>(X_clip[col].quantile(clip_lo))</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>        hi <span class="op">=</span> <span class="bu">float</span>(X_clip[col].quantile(clip_hi))</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>        X_clip[col] <span class="op">=</span> X_clip[col].clip(lower<span class="op">=</span>lo, upper<span class="op">=</span>hi)</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Impute + robust scale</span></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>    imputer <span class="op">=</span> SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>)</span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> RobustScaler(with_centering<span class="op">=</span><span class="va">True</span>, with_scaling<span class="op">=</span><span class="va">True</span>, quantile_range<span class="op">=</span>(<span class="fl">25.0</span>, <span class="fl">75.0</span>))</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>    X_imp <span class="op">=</span> imputer.fit_transform(X_clip)</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> scaler.fit_transform(X_imp)</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final cap in scaled space</span></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>    X_final <span class="op">=</span> np.clip(X_scaled, <span class="op">-</span>scaled_cap, scaled_cap)</span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X_final, <span class="bu">list</span>(X_clip.columns)</span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Baseline rebuild for consistent comparisons</span></span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>X_base, base_feature_names <span class="op">=</span> build_X_from_features(</span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>    df_view, MODEL_FEATURES, clip_lo<span class="op">=</span><span class="fl">0.01</span>, clip_hi<span class="op">=</span><span class="fl">0.99</span>, scaled_cap<span class="op">=</span>SCALED_CAP</span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>base_labels_for_sens <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>K_FINAL, n_init<span class="op">=</span><span class="dv">50</span>, random_state<span class="op">=</span><span class="dv">42</span>).fit_predict(X_base)</span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Define variants: drop one block at a time (excluding "category")</span></span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a>variants <span class="op">=</span> {}</span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> block <span class="kw">in</span> [<span class="st">"volume"</span>, <span class="st">"duration"</span>, <span class="st">"recency"</span>, <span class="st">"timing"</span>]:</span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>    keep <span class="op">=</span> []</span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> b, feats <span class="kw">in</span> FEATURE_BLOCKS.items():</span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> b <span class="op">==</span> <span class="st">"category"</span>:</span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb62-55"><a href="#cb62-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> b <span class="op">!=</span> block:</span>
<span id="cb62-56"><a href="#cb62-56" aria-hidden="true" tabindex="-1"></a>            keep <span class="op">+=</span> feats</span>
<span id="cb62-57"><a href="#cb62-57" aria-hidden="true" tabindex="-1"></a>    variants[<span class="ss">f"drop_</span><span class="sc">{</span>block<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> keep</span>
<span id="cb62-58"><a href="#cb62-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-59"><a href="#cb62-59" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> []</span>
<span id="cb62-60"><a href="#cb62-60" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, feats <span class="kw">in</span> variants.items():</span>
<span id="cb62-61"><a href="#cb62-61" aria-hidden="true" tabindex="-1"></a>    X_var, feat_names_var <span class="op">=</span> build_X_from_features(</span>
<span id="cb62-62"><a href="#cb62-62" aria-hidden="true" tabindex="-1"></a>        df_view, feats, clip_lo<span class="op">=</span><span class="fl">0.01</span>, clip_hi<span class="op">=</span><span class="fl">0.99</span>, scaled_cap<span class="op">=</span>SCALED_CAP</span>
<span id="cb62-63"><a href="#cb62-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-64"><a href="#cb62-64" aria-hidden="true" tabindex="-1"></a>    lab <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>K_FINAL, n_init<span class="op">=</span><span class="dv">50</span>, random_state<span class="op">=</span><span class="dv">42</span>).fit_predict(X_var)</span>
<span id="cb62-65"><a href="#cb62-65" aria-hidden="true" tabindex="-1"></a>    ari <span class="op">=</span> <span class="bu">float</span>(adjusted_rand_score(base_labels_for_sens, lab))</span>
<span id="cb62-66"><a href="#cb62-66" aria-hidden="true" tabindex="-1"></a>    rows.append({</span>
<span id="cb62-67"><a href="#cb62-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">"variant"</span>: name,</span>
<span id="cb62-68"><a href="#cb62-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_features"</span>: <span class="bu">int</span>(X_var.shape[<span class="dv">1</span>]),</span>
<span id="cb62-69"><a href="#cb62-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ari_vs_baseline"</span>: ari</span>
<span id="cb62-70"><a href="#cb62-70" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb62-71"><a href="#cb62-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-72"><a href="#cb62-72" aria-hidden="true" tabindex="-1"></a>block_sensitivity <span class="op">=</span> (</span>
<span id="cb62-73"><a href="#cb62-73" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame(rows)</span>
<span id="cb62-74"><a href="#cb62-74" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"ari_vs_baseline"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb62-75"><a href="#cb62-75" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-76"><a href="#cb62-76" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-77"><a href="#cb62-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-78"><a href="#cb62-78" aria-hidden="true" tabindex="-1"></a>block_sensitivity</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="124">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">variant</th>
<th data-quarto-table-cell-role="th">n_features</th>
<th data-quarto-table-cell-role="th">ari_vs_baseline</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>drop_timing</td>
<td>14</td>
<td>1.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>drop_volume</td>
<td>15</td>
<td>0.943619</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>drop_recency</td>
<td>18</td>
<td>0.738307</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>drop_duration</td>
<td>13</td>
<td>0.698273</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="sensitivity-summary-decision-useful" class="level3" data-number="7.5">
<h3 data-number="7.5" class="anchored" data-anchor-id="sensitivity-summary-decision-useful"><span class="header-section-number">7.5</span> Sensitivity summary (decision-useful)</h3>
<div id="a93b68d0" class="cell" data-execution_count="56">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>sens_audit <span class="op">=</span> pd.DataFrame({</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"K_FINAL"</span>: [K_FINAL],</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"seed_stability_ari_median"</span>: [<span class="bu">float</span>(seed_audit[<span class="st">"ari_median"</span>].iloc[<span class="dv">0</span>])],</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"seed_stability_ari_p05"</span>: [<span class="bu">float</span>(seed_audit[<span class="st">"ari_p05"</span>].iloc[<span class="dv">0</span>])],</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"seed_stability_ari_min"</span>: [<span class="bu">float</span>(seed_audit[<span class="st">"ari_min"</span>].iloc[<span class="dv">0</span>])],</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"block_sensitivity_ari_min"</span>: [<span class="bu">float</span>(block_sensitivity[<span class="st">"ari_vs_baseline"</span>].<span class="bu">min</span>())],</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"block_sensitivity_ari_median"</span>: [<span class="bu">float</span>(block_sensitivity[<span class="st">"ari_vs_baseline"</span>].median())],</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>sens_audit.T</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="125">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">K_FINAL</th>
<td>4.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">seed_stability_ari_median</th>
<td>1.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">seed_stability_ari_p05</th>
<td>1.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">seed_stability_ari_min</th>
<td>1.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">block_sensitivity_ari_min</th>
<td>0.698273</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">block_sensitivity_ari_median</th>
<td>0.840963</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>What we conclude here (based on your results)
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Seed stability:</strong> ARI is <span class="math inline">\(1.0\)</span> for all tested seeds <span class="math inline">\(\Rightarrow\)</span> K-means solution is <em>fully stable</em>.</li>
<li><strong>Block sensitivity:</strong> dropping <strong>duration</strong> or <strong>recency</strong> reduces agreement (ARI <span class="math inline">\(\approx 0.70\)</span>–<span class="math inline">\(0.74\)</span>), which implies these blocks carry meaningful segmentation signal.</li>
</ul>
<p>This is robust enough for stakeholder-facing use, with a clear explanation of what drives the segments.</p>
</div>
</div>
<hr>
</section>
<section id="store-robustness-artifacts-for-later-reporting" class="level3" data-number="7.6">
<h3 data-number="7.6" class="anchored" data-anchor-id="store-robustness-artifacts-for-later-reporting"><span class="header-section-number">7.6</span> Store robustness artifacts (for later reporting)</h3>
<div id="60773154" class="cell" data-execution_count="57">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"seed_stability"</span>] <span class="op">=</span> seed_stability</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"seed_audit"</span>] <span class="op">=</span> seed_audit</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"labels_worst_seed"</span>] <span class="op">=</span> labels_worst</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"labels_worst_seed_aligned"</span>] <span class="op">=</span> labels_worst_aligned</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"size_compare_worst_seed"</span>] <span class="op">=</span> size_compare.reset_index()</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"worst_seed_label_mapping"</span>] <span class="op">=</span> mapping</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"block_sensitivity"</span>] <span class="op">=</span> block_sensitivity</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"sens_audit"</span>] <span class="op">=</span> sens_audit</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(prep.keys())[:<span class="dv">25</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="126">
<pre><code>['MODEL_FEATURES',
 'FEATURE_BLOCKS',
 'feature_names',
 'imputer',
 'scaler',
 'X_raw',
 'X_clip',
 'X',
 'clip_table',
 'dominance',
 'preprocess_audit',
 'X_uncapped',
 'K_FINAL',
 'kmeans',
 'labels',
 'contact_clusters',
 'cluster_sizes',
 'cards',
 'spread',
 'timing_summary',
 'cluster_labels',
 'cluster_story',
 'rules',
 'seed_stability',
 'seed_audit']</code></pre>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Phase 6 summary (robustness verdict)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Based on your results:</p>
<ul>
<li><strong>Seed stability (random restarts):</strong> <span class="math inline">\(ARI = 1.00\)</span> for all tested seeds <span class="math inline">\(\Rightarrow\)</span> the <span class="math inline">\(K=4\)</span> K-means solution is <strong>fully stable</strong> on <code>prep["X"]</code>.</li>
<li><strong>Feature-block sensitivity (drop-one-block):</strong>
<ul>
<li>Drop timing: <span class="math inline">\(ARI = 1.00\)</span> (timing is not driving the segmentation)</li>
<li>Drop volume: <span class="math inline">\(ARI \approx 0.94\)</span> (volume contributes, but is not the sole driver)</li>
<li>Drop recency: <span class="math inline">\(ARI \approx 0.74\)</span> (recency contains meaningful signal)</li>
<li>Drop duration: <span class="math inline">\(ARI \approx 0.70\)</span> (duration contains meaningful signal)</li>
</ul></li>
</ul>
<p><strong>Decision-useful takeaway:</strong> The segmentation is stable and not an artifact of random initialization.<br>
The clusters are primarily supported by <strong>duration</strong> and <strong>recency</strong> behaviour (with volume contributing), so these are the main behavioural levers to emphasize in stakeholder explanations.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="phase-7-pca-visualization-for-interpretation-only" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="phase-7-pca-visualization-for-interpretation-only"><span class="header-section-number">8</span> Phase 7 — PCA visualization (for interpretation only)</h2>
<p>PCA is <strong>not</strong> used to train clustering.<br>
We use PCA only to create a 2D “map” of contacts for storytelling, sanity-checking, and explaining separation.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>PCA is not the clustering model
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Clustering was trained on:</strong> <code>prep["X"]</code> (robust-scaled + capped)</li>
<li><strong>PCA is used for:</strong> visualization only (2D projection) If PCA looks messy, it does <strong>not</strong> automatically mean clustering is wrong. PCA compresses information into 2 dimensions.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Privacy
</div>
</div>
<div class="callout-body-container callout-body">
<p>We plot only:</p>
<ul>
<li>PCA coordinates</li>
<li>cluster labels We do <strong>not</strong> plot names or phone numbers, and we keep <code>contact_id</code> hashed.</li>
</ul>
</div>
</div>
<hr>
<section id="fit-pca-2-components-on-the-clustering-matrix" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="fit-pca-2-components-on-the-clustering-matrix"><span class="header-section-number">8.1</span> Fit PCA (<span class="math inline">\(2\)</span> components) on the clustering matrix</h3>
<div id="d4f653fd" class="cell" data-execution_count="58">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> prep[<span class="st">"X"</span>]  <span class="co"># scaled + capped matrix used for clustering</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> np.asarray(prep[<span class="st">"labels"</span>])</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>K_FINAL <span class="op">=</span> <span class="bu">int</span>(prep.get(<span class="st">"K_FINAL"</span>, <span class="dv">4</span>))</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>pca <span class="op">=</span> PCA(n_components<span class="op">=</span><span class="dv">2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>Z <span class="op">=</span> pca.fit_transform(X)</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>pca_audit <span class="op">=</span> pd.DataFrame({</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_components"</span>: [<span class="dv">2</span>],</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"explained_var_ratio_pc1"</span>: [<span class="bu">float</span>(pca.explained_variance_ratio_[<span class="dv">0</span>])],</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"explained_var_ratio_pc2"</span>: [<span class="bu">float</span>(pca.explained_variance_ratio_[<span class="dv">1</span>])],</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"explained_var_ratio_total_2pc"</span>: [<span class="bu">float</span>(pca.explained_variance_ratio_[:<span class="dv">2</span>].<span class="bu">sum</span>())],</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>pca_audit</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="127">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_components</th>
<th data-quarto-table-cell-role="th">explained_var_ratio_pc1</th>
<th data-quarto-table-cell-role="th">explained_var_ratio_pc2</th>
<th data-quarto-table-cell-role="th">explained_var_ratio_total_2pc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2</td>
<td>0.628668</td>
<td>0.215786</td>
<td>0.844454</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="build-a-plotting-table-hashed-id-pca-coordinates-cluster" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="build-a-plotting-table-hashed-id-pca-coordinates-cluster"><span class="header-section-number">8.2</span> Build a plotting table (hashed id + PCA coordinates + cluster)</h3>
<div id="3bddff62" class="cell" data-execution_count="59">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>pca_view <span class="op">=</span> pd.DataFrame({</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"contact_id"</span>: contact_features_view[<span class="st">"contact_id"</span>].values,  <span class="co"># hashed only</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pc1"</span>: Z[:, <span class="dv">0</span>],</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pc2"</span>: Z[:, <span class="dv">1</span>],</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cluster"</span>: labels</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>pca_view.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="128">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">contact_id</th>
<th data-quarto-table-cell-role="th">pc1</th>
<th data-quarto-table-cell-role="th">pc2</th>
<th data-quarto-table-cell-role="th">cluster</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>00047e187745</td>
<td>-3.211533</td>
<td>-0.439848</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>000d71073f3e</td>
<td>17.283469</td>
<td>-2.797619</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>001c36642ecb</td>
<td>6.364608</td>
<td>-1.535155</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>00ad9a0b1291</td>
<td>-2.066420</td>
<td>3.971317</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>00ed0d18f9e3</td>
<td>-1.794263</td>
<td>1.314460</td>
<td>2</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="pca-scatter-plot-clusters-on-the-2d-map" class="level3" data-number="8.3">
<h3 data-number="8.3" class="anchored" data-anchor-id="pca-scatter-plot-clusters-on-the-2d-map"><span class="header-section-number">8.3</span> PCA scatter plot (clusters on the 2D map)</h3>
<div id="fbba3da2" class="cell" data-execution_count="60">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot each cluster separately for a clear legend</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> <span class="bu">sorted</span>(pca_view[<span class="st">"cluster"</span>].unique()):</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    sub <span class="op">=</span> pca_view[pca_view[<span class="st">"cluster"</span>] <span class="op">==</span> c]</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    ax.scatter(sub[<span class="st">"pc1"</span>], sub[<span class="st">"pc2"</span>], s<span class="op">=</span><span class="dv">12</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="ss">f"Cluster </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="ss">f"PCA map of contacts (K-means clusters, $K=</span><span class="sc">{</span>K_FINAL<span class="sc">}</span><span class="ss">$)"</span>)</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"PC1"</span>)</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"PC2"</span>)</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>ax.legend(title<span class="op">=</span><span class="st">"Cluster"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="walsoft_contact_segmentation_files/figure-html/cell-61-output-1.png" width="662" height="524" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="optional-cluster-centroids-projected-into-pca-space" class="level3" data-number="8.4">
<h3 data-number="8.4" class="anchored" data-anchor-id="optional-cluster-centroids-projected-into-pca-space"><span class="header-section-number">8.4</span> Optional: cluster centroids projected into PCA space</h3>
<p>This helps stakeholders see “where the centers sit” on the map.</p>
<div id="94fb0a47" class="cell" data-execution_count="61">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># K-means centroids exist in scaled feature space; PCA was fit on the same space.</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>centroids <span class="op">=</span> prep[<span class="st">"kmeans"</span>].cluster_centers_</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>centroids_2d <span class="op">=</span> pca.transform(centroids)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>cent <span class="op">=</span> pd.DataFrame({</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cluster"</span>: <span class="bu">list</span>(<span class="bu">range</span>(K_FINAL)),</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pc1_centroid"</span>: centroids_2d[:, <span class="dv">0</span>],</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pc2_centroid"</span>: centroids_2d[:, <span class="dv">1</span>],</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>cent</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="130">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cluster</th>
<th data-quarto-table-cell-role="th">pc1_centroid</th>
<th data-quarto-table-cell-role="th">pc2_centroid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0</td>
<td>4.245796</td>
<td>11.770443</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>1</td>
<td>15.100966</td>
<td>-1.621873</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2</td>
<td>-2.582659</td>
<td>-0.175937</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>3</td>
<td>4.824594</td>
<td>-2.241496</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="5cf0dc17" class="cell" data-execution_count="62">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> <span class="bu">sorted</span>(pca_view[<span class="st">"cluster"</span>].unique()):</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    sub <span class="op">=</span> pca_view[pca_view[<span class="st">"cluster"</span>] <span class="op">==</span> c]</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    ax.scatter(sub[<span class="st">"pc1"</span>], sub[<span class="st">"pc2"</span>], s<span class="op">=</span><span class="dv">10</span>, alpha<span class="op">=</span><span class="fl">0.45</span>, label<span class="op">=</span><span class="ss">f"Cluster </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Centroids</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>ax.scatter(cent[<span class="st">"pc1_centroid"</span>], cent[<span class="st">"pc2_centroid"</span>], s<span class="op">=</span><span class="dv">120</span>, marker<span class="op">=</span><span class="st">"X"</span>, label<span class="op">=</span><span class="st">"Centroids"</span>)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="ss">f"PCA map with centroids (K=</span><span class="sc">{</span>K_FINAL<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"PC1"</span>)</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"PC2"</span>)</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>ax.legend(fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="walsoft_contact_segmentation_files/figure-html/cell-63-output-1.png" width="662" height="523" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="interpretation-guidance-what-we-conclude-from-pca" class="level3" data-number="8.5">
<h3 data-number="8.5" class="anchored" data-anchor-id="interpretation-guidance-what-we-conclude-from-pca"><span class="header-section-number">8.5</span> Interpretation guidance (what we conclude from PCA)</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>PCA is a <strong>compression</strong> from many dimensions down to 2.</p>
<p>Use this plot to check:</p>
<ul>
<li>whether clusters are <em>roughly separated</em> (good sign),</li>
<li>whether some clusters overlap heavily (could be fine; segmentation can still be valid),</li>
<li>whether a small cluster looks like extreme outliers (could indicate a “special handling” segment).</li>
</ul>
<p>Do <strong>not</strong> use PCA to choose <span class="math inline">\(K\)</span> or to claim “the true number of clusters.”</p>
</div>
</div>
<hr>
</section>
<section id="store-pca-artifacts-for-the-final-report" class="level3" data-number="8.6">
<h3 data-number="8.6" class="anchored" data-anchor-id="store-pca-artifacts-for-the-final-report"><span class="header-section-number">8.6</span> Store PCA artifacts (for the final report)</h3>
<div id="d7597e17" class="cell" data-execution_count="63">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"pca_model"</span>] <span class="op">=</span> pca</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"pca_audit"</span>] <span class="op">=</span> pca_audit</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"pca_view"</span>] <span class="op">=</span> pca_view</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>prep[<span class="st">"pca_centroids_2d"</span>] <span class="op">=</span> cent</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(prep.keys())[:<span class="dv">30</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="132">
<pre><code>['MODEL_FEATURES',
 'FEATURE_BLOCKS',
 'feature_names',
 'imputer',
 'scaler',
 'X_raw',
 'X_clip',
 'X',
 'clip_table',
 'dominance',
 'preprocess_audit',
 'X_uncapped',
 'K_FINAL',
 'kmeans',
 'labels',
 'contact_clusters',
 'cluster_sizes',
 'cards',
 'spread',
 'timing_summary',
 'cluster_labels',
 'cluster_story',
 'rules',
 'seed_stability',
 'seed_audit',
 'labels_worst_seed',
 'labels_worst_seed_aligned',
 'size_compare_worst_seed',
 'worst_seed_label_mapping',
 'block_sensitivity']</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="what-pca-tells-us-interpretation-only" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="what-pca-tells-us-interpretation-only"><span class="header-section-number">9</span> What PCA tells us (interpretation only)</h2>
<p>PCA is a 2D projection of the same scaled training matrix used for clustering, <code>prep["X"]</code>. It does <strong>not</strong> change the model; it only helps us <em>see</em> separation.</p>
<section id="variance-captured" class="level3" data-number="9.1">
<h3 data-number="9.1" class="anchored" data-anchor-id="variance-captured"><span class="header-section-number">9.1</span> Variance captured</h3>
<p>From <code>pca_audit</code>, the first two components explain:</p>
<ul>
<li><span class="math inline">\(PC1 \approx 0.629\)</span></li>
<li><span class="math inline">\(PC2 \approx 0.216\)</span></li>
<li>Total (2D) <span class="math inline">\(\approx 0.844\)</span></li>
</ul>
<p>So about <strong>84.4%</strong> of the variance in the scaled feature space is visible in the 2D map. That is high enough that the plot is a meaningful sanity-check.</p>
</section>
<section id="visual-separation-sanity-check" class="level3" data-number="9.2">
<h3 data-number="9.2" class="anchored" data-anchor-id="visual-separation-sanity-check"><span class="header-section-number">9.2</span> Visual separation (sanity-check)</h3>
<p>The PCA map shows clear structure:</p>
<ul>
<li>One cluster sits far to the <strong>right</strong> on <span class="math inline">\(PC1\)</span> (strong separation in the main direction of variance).</li>
<li>One cluster is concentrated far to the <strong>left</strong> (tight wedge near low <span class="math inline">\(PC1\)</span> values).</li>
<li>Two clusters occupy the middle/bottom region with partial overlap, suggesting they differ in <em>multiple</em> dimensions (not fully separable in 2D, which is normal).</li>
</ul>
<p>This supports the earlier interpretation: the segmentation is not an artifact of one random run (Phase 6 already proved stability), and the clusters correspond to genuinely different behavioral regimes in feature space.</p>
</section>
<section id="centroids-on-the-pca-map" class="level3" data-number="9.3">
<h3 data-number="9.3" class="anchored" data-anchor-id="centroids-on-the-pca-map"><span class="header-section-number">9.3</span> Centroids on the PCA map</h3>
<p>Projected centroids help explain “where the centers sit”:</p>
<ul>
<li>The centroid that is far right on <span class="math inline">\(PC1\)</span> corresponds to a high-intensity / high-activity regime.</li>
<li>The centroid that is far left corresponds to low-engagement / near-baseline contacts.</li>
<li>The centroid that is high on <span class="math inline">\(PC2\)</span> indicates a behavior pattern that is not just “more or less activity,” but a different mix (often duration/recency-related structure).</li>
</ul>
<p><strong>Important:</strong> overlap in PCA does not invalidate clusters. K-means was fit in the full feature space; PCA compresses information into 2 dimensions.</p>
<hr>
</section>
</section>
<section id="phase-8-final-deliverables-stakeholder-ready-outputs" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="phase-8-final-deliverables-stakeholder-ready-outputs"><span class="header-section-number">10</span> Phase 8 — Final deliverables (stakeholder-ready outputs)</h2>
<p>In this phase we package the work into <strong>decision-ready artifacts</strong> that can be used in a CRM or reporting workflow <strong>without exposing identities</strong>.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Privacy and operational use
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>We <strong>do not</strong> join names or phone numbers into any outputs.</li>
<li>All contact identifiers remain <strong>hashed</strong>.</li>
<li>Default is <strong>no file export</strong>. You can enable export if you want portfolio artifacts.</li>
</ul>
</div>
</div>
<hr>
<section id="assemble-the-final-segment-table-labels-key-medians" class="level3" data-number="10.1">
<h3 data-number="10.1" class="anchored" data-anchor-id="assemble-the-final-segment-table-labels-key-medians"><span class="header-section-number">10.1</span> Assemble the “final segment table” (labels + key medians)</h3>
<div id="c78bbbf3" class="cell" data-execution_count="64">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Guardrails</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>required <span class="op">=</span> [<span class="st">"cards"</span>, <span class="st">"cluster_labels"</span>, <span class="st">"rules"</span>, <span class="st">"sens_audit"</span>, <span class="st">"pca_audit"</span>]</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>missing <span class="op">=</span> [k <span class="cf">for</span> k <span class="kw">in</span> required <span class="cf">if</span> k <span class="kw">not</span> <span class="kw">in</span> prep]</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(missing) <span class="op">==</span> <span class="dv">0</span>, <span class="ss">f"Missing Phase artifacts in prep: </span><span class="sc">{</span>missing<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>cards <span class="op">=</span> prep[<span class="st">"cards"</span>].copy()</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>cluster_labels <span class="op">=</span> prep[<span class="st">"cluster_labels"</span>].copy()</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>rules <span class="op">=</span> prep[<span class="st">"rules"</span>].copy()</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Join: cluster -&gt; segment label + action</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>final_segments <span class="op">=</span> (</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>    cards.merge(cluster_labels[[<span class="st">"cluster"</span>, <span class="st">"segment_label"</span>, <span class="st">"primary_action"</span>]], on<span class="op">=</span><span class="st">"cluster"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"n_contacts"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Reorder columns for a stakeholder view</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>front <span class="op">=</span> [<span class="st">"cluster"</span>, <span class="st">"segment_label"</span>, <span class="st">"n_contacts"</span>, <span class="st">"primary_action"</span>]</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>rest <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> final_segments.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> front]</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>final_segments <span class="op">=</span> final_segments[front <span class="op">+</span> rest]</span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>final_segments</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="133">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cluster</th>
<th data-quarto-table-cell-role="th">segment_label</th>
<th data-quarto-table-cell-role="th">n_contacts</th>
<th data-quarto-table-cell-role="th">primary_action</th>
<th data-quarto-table-cell-role="th">n_calls</th>
<th data-quarto-table-cell-role="th">n_days_active</th>
<th data-quarto-table-cell-role="th">calls_per_active_day</th>
<th data-quarto-table-cell-role="th">total_dur_sec</th>
<th data-quarto-table-cell-role="th">median_dur_sec</th>
<th data-quarto-table-cell-role="th">long_call_share</th>
<th data-quarto-table-cell-role="th">recency_days</th>
<th data-quarto-table-cell-role="th">tenure_days</th>
<th data-quarto-table-cell-role="th">share_business_hours</th>
<th data-quarto-table-cell-role="th">share_evening</th>
<th data-quarto-table-cell-role="th">share_early_morning</th>
<th data-quarto-table-cell-role="th">share_late_night</th>
<th data-quarto-table-cell-role="th">share_open_day</th>
<th data-quarto-table-cell-role="th">share_closed_day</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2</td>
<td>One-off / low-engagement contacts</td>
<td>1599</td>
<td>Deprioritize by default; automate nurture; rea...</td>
<td>1.0</td>
<td>1.0</td>
<td>1.000000</td>
<td>61.0</td>
<td>37.0</td>
<td>0.0</td>
<td>501.331516</td>
<td>0.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.0</td>
<td>1.000000</td>
<td>0.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>3</td>
<td>Warm occasional contacts</td>
<td>225</td>
<td>Nurture cadence (monthly/quarterly); structure...</td>
<td>5.0</td>
<td>4.0</td>
<td>1.333333</td>
<td>270.0</td>
<td>34.0</td>
<td>0.0</td>
<td>259.384988</td>
<td>312.908426</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.0</td>
<td>1.000000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>1</td>
<td>Core active relationships</td>
<td>176</td>
<td>Retention + priority servicing; assign owner; ...</td>
<td>35.5</td>
<td>21.0</td>
<td>1.707143</td>
<td>2776.0</td>
<td>35.5</td>
<td>0.0</td>
<td>84.802164</td>
<td>676.594664</td>
<td>0.911879</td>
<td>0.047619</td>
<td>0.0</td>
<td>0.0</td>
<td>0.983416</td>
<td>0.016584</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>0</td>
<td>Rare deep conversations</td>
<td>91</td>
<td>High-touch when active; preserve context; pers...</td>
<td>2.0</td>
<td>2.0</td>
<td>1.200000</td>
<td>1553.0</td>
<td>494.0</td>
<td>0.6</td>
<td>621.220833</td>
<td>0.813924</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.0</td>
<td>1.000000</td>
<td>0.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="decision-rules-crm-outreach-policy" class="level3" data-number="10.2">
<h3 data-number="10.2" class="anchored" data-anchor-id="decision-rules-crm-outreach-policy"><span class="header-section-number">10.2</span> Decision rules (CRM / outreach policy)</h3>
<div id="869856a6" class="cell" data-execution_count="65">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>rules</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="134">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">segment_label</th>
<th data-quarto-table-cell-role="th">decision_use</th>
<th data-quarto-table-cell-role="th">operational_rule</th>
<th data-quarto-table-cell-role="th">typical_pattern</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Core active relationships</td>
<td>Prioritization and retention</td>
<td>Assign owner and SLA; proactive check-ins</td>
<td>High calls, many active days, low recency</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Warm occasional contacts</td>
<td>Nurture and growth</td>
<td>Monthly/quarterly outreach; reminders; targete...</td>
<td>Moderate repeat calls, moderate tenure, mid re...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Rare deep conversations</td>
<td>High-touch exceptions and win-back</td>
<td>Personalized follow-up; preserve context; targ...</td>
<td>Few calls but long conversations (high median ...</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>One-off / low-engagement contacts</td>
<td>Noise filtering and automation</td>
<td>Exclude from priority lists; automate nurture ...</td>
<td>One call, one day, small total duration, often...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="executive-summary-one-screen" class="level3" data-number="10.3">
<h3 data-number="10.3" class="anchored" data-anchor-id="executive-summary-one-screen"><span class="header-section-number">10.3</span> “Executive summary” (one screen)</h3>
<div id="cba978ac" class="cell" data-execution_count="66">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>sens_audit <span class="op">=</span> prep[<span class="st">"sens_audit"</span>].copy()</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>pca_audit <span class="op">=</span> prep[<span class="st">"pca_audit"</span>].copy()</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Key stats</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>n_contacts_total <span class="op">=</span> <span class="bu">int</span>(prep[<span class="st">"contact_clusters"</span>].shape[<span class="dv">0</span>])</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>k_final <span class="op">=</span> <span class="bu">int</span>(prep.get(<span class="st">"K_FINAL"</span>, <span class="dv">4</span>))</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>seed_median <span class="op">=</span> <span class="bu">float</span>(sens_audit[<span class="st">"seed_stability_ari_median"</span>].iloc[<span class="dv">0</span>])</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>seed_min <span class="op">=</span> <span class="bu">float</span>(sens_audit[<span class="st">"seed_stability_ari_min"</span>].iloc[<span class="dv">0</span>])</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>block_min <span class="op">=</span> <span class="bu">float</span>(sens_audit[<span class="st">"block_sensitivity_ari_min"</span>].iloc[<span class="dv">0</span>])</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>pca_total2 <span class="op">=</span> <span class="bu">float</span>(pca_audit[<span class="st">"explained_var_ratio_total_2pc"</span>].iloc[<span class="dv">0</span>])</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>exec_summary <span class="op">=</span> pd.DataFrame([{</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_contacts_clustered"</span>: n_contacts_total,</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"K_FINAL"</span>: k_final,</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"seed_stability_ARI_median"</span>: seed_median,</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"seed_stability_ARI_min"</span>: seed_min,</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"block_sensitivity_ARI_min"</span>: block_min,</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pca_variance_explained_2PC"</span>: pca_total2,</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>}])</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>exec_summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="135">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_contacts_clustered</th>
<th data-quarto-table-cell-role="th">K_FINAL</th>
<th data-quarto-table-cell-role="th">seed_stability_ARI_median</th>
<th data-quarto-table-cell-role="th">seed_stability_ARI_min</th>
<th data-quarto-table-cell-role="th">block_sensitivity_ARI_min</th>
<th data-quarto-table-cell-role="th">pca_variance_explained_2PC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2091</td>
<td>4</td>
<td>1.0</td>
<td>1.0</td>
<td>0.698273</td>
<td>0.844454</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="findings-plain-english-decision-first" class="level3" data-number="10.4">
<h3 data-number="10.4" class="anchored" data-anchor-id="findings-plain-english-decision-first"><span class="header-section-number">10.4</span> Findings (plain-English, decision-first)</h3>
<div id="2532c6e9" class="cell" data-execution_count="67">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the segment table into a short narrative summary</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>seg_counts <span class="op">=</span> final_segments[[<span class="st">"segment_label"</span>, <span class="st">"n_contacts"</span>]].copy()</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>seg_counts[<span class="st">"share_pct"</span>] <span class="op">=</span> (seg_counts[<span class="st">"n_contacts"</span>] <span class="op">/</span> seg_counts[<span class="st">"n_contacts"</span>].<span class="bu">sum</span>() <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>seg_counts</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="136">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">segment_label</th>
<th data-quarto-table-cell-role="th">n_contacts</th>
<th data-quarto-table-cell-role="th">share_pct</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>One-off / low-engagement contacts</td>
<td>1599</td>
<td>76.47</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Warm occasional contacts</td>
<td>225</td>
<td>10.76</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Core active relationships</td>
<td>176</td>
<td>8.42</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Rare deep conversations</td>
<td>91</td>
<td>4.35</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="74ad8848" class="cell" data-execution_count="68">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build a compact “what it is + what to do” list (no IDs)</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>labels_idx <span class="op">=</span> cluster_labels.set_index(<span class="st">"segment_label"</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> []</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, r <span class="kw">in</span> seg_counts.iterrows():</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    seg <span class="op">=</span> r[<span class="st">"segment_label"</span>]</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">int</span>(r[<span class="st">"n_contacts"</span>])</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    pct <span class="op">=</span> <span class="bu">float</span>(r[<span class="st">"share_pct"</span>])</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>    action <span class="op">=</span> labels_idx.loc[seg, <span class="st">"primary_action"</span>] <span class="cf">if</span> seg <span class="kw">in</span> labels_idx.index <span class="cf">else</span> <span class="st">"TBD"</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    rows.append({<span class="st">"segment_label"</span>: seg, <span class="st">"n_contacts"</span>: n, <span class="st">"share_pct"</span>: pct, <span class="st">"default_action"</span>: action})</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>findings_table <span class="op">=</span> pd.DataFrame(rows).sort_values(<span class="st">"n_contacts"</span>, ascending<span class="op">=</span><span class="va">False</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>findings_table</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="137">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">segment_label</th>
<th data-quarto-table-cell-role="th">n_contacts</th>
<th data-quarto-table-cell-role="th">share_pct</th>
<th data-quarto-table-cell-role="th">default_action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>One-off / low-engagement contacts</td>
<td>1599</td>
<td>76.47</td>
<td>Deprioritize by default; automate nurture; rea...</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Warm occasional contacts</td>
<td>225</td>
<td>10.76</td>
<td>Nurture cadence (monthly/quarterly); structure...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Core active relationships</td>
<td>176</td>
<td>8.42</td>
<td>Retention + priority servicing; assign owner; ...</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Rare deep conversations</td>
<td>91</td>
<td>4.35</td>
<td>High-touch when active; preserve context; pers...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>What we learned from your results
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>The solution is fully stable to random initialization</strong> (seed ARI <span class="math inline">\(\approx 1\)</span> across tested seeds), so you can rerun K-means and get the same segmentation (up to label permutation).</li>
<li><strong>Recency and duration matter</strong>: dropping either block reduces agreement (lower ARI), so those blocks carry meaningful segmentation signal.</li>
<li><strong>PCA is supportive, not decisive</strong>: the first two PCs explain a large share of variance, and the 2D map shows visible separation patterns that align with the segmentation.</li>
</ul>
</div>
</div>
<hr>
</section>
<section id="limitations-and-how-not-to-misuse-this" class="level3" data-number="10.5">
<h3 data-number="10.5" class="anchored" data-anchor-id="limitations-and-how-not-to-misuse-this"><span class="header-section-number">10.5</span> Limitations and “how not to misuse this”</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Limitations
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>This is <strong>behavior-based segmentation</strong>, not a causal model. It supports prioritization and outreach strategy, not “ground truth identities.”</li>
<li>K-means assumes roughly spherical clusters in the feature space. If your business needs non-spherical shapes, consider alternative methods later (e.g., GMM, HDBSCAN).</li>
<li>Very sparse contacts (1–2 calls) can make share features extreme; we handled this by using medians + mean/%-any checks for timing.</li>
</ul>
</div>
</div>
<hr>
</section>
<section id="optional-export-portfolio-artifacts-off-by-default" class="level3" data-number="10.6">
<h3 data-number="10.6" class="anchored" data-anchor-id="optional-export-portfolio-artifacts-off-by-default"><span class="header-section-number">10.6</span> Optional: export portfolio artifacts (OFF by default)</h3>
<div id="82aa87be" class="cell" data-execution_count="69">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>SAVE_FILES <span class="op">=</span> <span class="va">False</span>  <span class="co"># keep False unless you explicitly want exports</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> SAVE_FILES:</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># These contain NO names/phone numbers. contact_id stays hashed.</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    final_segments.to_csv(<span class="st">"final_segments_cluster_cards.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    rules.to_csv(<span class="st">"segment_policy_rules.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    findings_table.to_csv(<span class="st">"segment_findings_summary.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    exec_summary.to_csv(<span class="st">"executive_summary_metrics.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Saved CSV files (hashed IDs only, no raw identifiers)."</span>)</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"SAVE_FILES=False (no files written)."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>SAVE_FILES=False (no files written).</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="phase-10-final-wrap-up-competition-framing-decision-narrative" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="phase-10-final-wrap-up-competition-framing-decision-narrative"><span class="header-section-number">11</span> Phase 10 — Final wrap-up (competition framing + decision narrative)</h2>
<section id="competition-prompt-what-we-were-given" class="level3" data-number="11.1">
<h3 data-number="11.1" class="anchored" data-anchor-id="competition-prompt-what-we-were-given"><span class="header-section-number">11.1</span> Competition prompt (what we were given)</h3>
<p><strong>We were given</strong> a historical phone-call behaviour dataset where each record represents a call event.<br>
The dataset includes <strong>timestamps, call duration, and categorised call context</strong>, but <strong>no business labels</strong> such as “good customer” or “bad customer”.</p>
<p><strong>Task:</strong> Without supervision (no labels), we had to build a <strong>contact-level segmentation</strong> that a business could actually use for prioritisation, outreach cadence, and relationship management.</p>
<p><strong>Hard constraints:</strong></p>
<ul>
<li><strong>Privacy-first:</strong> do not use names or phone numbers; keep identifiers hashed.</li>
<li><strong>Operational:</strong> output must translate into <strong>clear segment actions</strong>, not just clusters.</li>
<li><strong>Professional robustness:</strong> results must be stable, not a “nice plot”.</li>
</ul>
<hr>
</section>
<section id="what-we-had-to-produce-deliverable-definition" class="level3" data-number="11.2">
<h3 data-number="11.2" class="anchored" data-anchor-id="what-we-had-to-produce-deliverable-definition"><span class="header-section-number">11.2</span> What we had to produce (deliverable definition)</h3>
<p>We had to deliver:</p>
<ol type="1">
<li>A <strong>clean contact-level feature table</strong> (one row per contact).</li>
<li>A <strong>distance-ready clustering matrix</strong> (robust preprocessing).</li>
<li>A final segmentation using <strong>K-means with <span class="math inline">\(K=4\)</span></strong>.</li>
<li><strong>Stakeholder-ready interpretation</strong> (cluster “cards” + segment labels + default actions).</li>
<li><strong>Robustness evidence</strong> (seed stability and feature sensitivity).</li>
<li><strong>Interpretation-only visual sanity-check</strong> (PCA map).</li>
</ol>
<hr>
</section>
<section id="what-we-built-end-to-end-pipeline" class="level3" data-number="11.3">
<h3 data-number="11.3" class="anchored" data-anchor-id="what-we-built-end-to-end-pipeline"><span class="header-section-number">11.3</span> What we built (end-to-end pipeline)</h3>
<ol type="1">
<li><strong>Audit</strong> the raw call-event data (types, missingness, constraints).</li>
<li><strong>Aggregate to contacts</strong> (the clustering unit), producing features that capture:
<ul>
<li>volume/intensity (calls, active days),</li>
<li>relationship depth proxy (duration metrics, long-call share),</li>
<li>recency/tenure (dormancy vs continuity),</li>
<li>timing mix (business hours vs off-hours).</li>
</ul></li>
<li><strong>Preprocess for K-means</strong>:
<ul>
<li>clip extreme values in raw space,</li>
<li>median imputation,</li>
<li>robust scaling,</li>
<li>cap scaled values for numerical stability.</li>
</ul></li>
<li><strong>Fit K-means</strong> with <span class="math inline">\(K=4\)</span> and attach labels to contacts (hashed IDs only).</li>
<li><strong>Interpret</strong> clusters using raw units and translate into segments + actions.</li>
<li><strong>Validate robustness</strong> using ARI across seeds and drop-one-block sensitivity.</li>
<li><strong>Use PCA only for visualization</strong> (interpretation, not training).</li>
</ol>
<hr>
</section>
<section id="the-segments-what-we-found-what-to-do" class="level3" data-number="11.4">
<h3 data-number="11.4" class="anchored" data-anchor-id="the-segments-what-we-found-what-to-do"><span class="header-section-number">11.4</span> The segments (what we found + what to do)</h3>
<p>From the cluster cards and behaviour-based mapping, we obtained four operational segments:</p>
<ul>
<li><p><strong>One-off / low-engagement contacts</strong> (largest share)<br>
<strong>Action:</strong> deprioritize by default; automate nurture; reactivate only if new activity appears.</p></li>
<li><p><strong>Warm occasional contacts</strong><br>
<strong>Action:</strong> nurture cadence (monthly/quarterly); structured check-ins to increase engagement.</p></li>
<li><p><strong>Core active relationships</strong><br>
<strong>Action:</strong> retention and priority servicing; assign owner; proactive follow-ups.</p></li>
<li><p><strong>Rare deep conversations</strong><br>
<strong>Action:</strong> high-touch when active; preserve context; personalized re-engagement when dormant.</p></li>
</ul>
<hr>
</section>
<section id="proof-the-solution-holds-up-robustness" class="level3" data-number="11.5">
<h3 data-number="11.5" class="anchored" data-anchor-id="proof-the-solution-holds-up-robustness"><span class="header-section-number">11.5</span> Proof the solution “holds up” (robustness)</h3>
<p><strong>Seed stability:</strong> ARI was <span class="math inline">\(1.00\)</span> across all tested seeds.<br>
So the segmentation is fully stable to random initialization (up to label permutation).</p>
<p><strong>Feature sensitivity:</strong> dropping duration or recency reduces agreement (ARI drops to about <span class="math inline">\(0.70\)</span>–<span class="math inline">\(0.74\)</span>).<br>
Interpretation: <strong>duration and recency carry meaningful segmentation signal</strong>; timing contributes less to the final partition.</p>
<hr>
</section>
<section id="what-pca-contributed-interpretation-only" class="level3" data-number="11.6">
<h3 data-number="11.6" class="anchored" data-anchor-id="what-pca-contributed-interpretation-only"><span class="header-section-number">11.6</span> What PCA contributed (interpretation only)</h3>
<p>PCA is a 2D projection of <code>prep["X"]</code> for storytelling and sanity-checking.</p>
<ul>
<li>The first two components explain about <span class="math inline">\(84.45\%\)</span> of variance.</li>
<li>The map shows visible structure consistent with the segmentation.</li>
<li>PCA overlap does not invalidate clusters because K-means was trained in the full feature space.</li>
</ul>
<hr>
</section>
<section id="decision-use-what-a-business-can-do-with-these-segments" class="level3" data-number="11.7">
<h3 data-number="11.7" class="anchored" data-anchor-id="decision-use-what-a-business-can-do-with-these-segments"><span class="header-section-number">11.7</span> Decision use: what a business can do with these segments</h3>
<ul>
<li><strong>Routing:</strong> prioritize “Core active” + “Rare deep” to high-touch handling.</li>
<li><strong>Cadence:</strong> automate outreach for “Warm occasional”; suppress manual effort for “One-off”.</li>
<li><strong>Reactivation:</strong> trigger win-back campaigns for dormant “Rare deep” and “Warm occasional”.</li>
<li><strong>Service levels:</strong> define SLA tiers using segment label and recency.</li>
</ul>
<hr>
</section>
<section id="limitations-how-not-to-misuse-this" class="level3" data-number="11.8">
<h3 data-number="11.8" class="anchored" data-anchor-id="limitations-how-not-to-misuse-this"><span class="header-section-number">11.8</span> Limitations (how not to misuse this)</h3>
<ul>
<li>This is behaviour segmentation, not identity inference and not causal.</li>
<li>K-means prefers spherical separation in feature space; alternative methods can be tested later.</li>
<li>Very sparse contacts can make timing shares extreme; we mitigated via robust summaries and mean/%-any checks.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Final deliverables:</strong></p>
<ul>
<li>A stable <span class="math inline">\(K=4\)</span> segmentation (hashed IDs only).</li>
<li>Stakeholder-ready cluster cards + action policy rules.</li>
<li>Robustness evidence (seed ARI + block sensitivity).</li>
<li>PCA map used only for interpretation and storytelling.</li>
</ul>
</div>
</div>
<hr>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/WALEKHWAPHILIP\.github\.io\/walsoft-contact-clustering\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>